import os
from autogen_ext.tools.mcp import StreamableHttpMcpToolAdapter, StreamableHttpServerParams
{%- if not custom_authorizer_enabled %}
import requests

COGNITO_TOKEN_URL = os.getenv("COGNITO_TOKEN_URL")
COGNITO_CLIENT_ID = os.getenv("COGNITO_CLIENT_ID")
COGNITO_CLIENT_SECRET = os.getenv("COGNITO_CLIENT_SECRET")

def _get_access_token():
    """
    Make a POST request to the Cognito OAuth token URL using client credentials.
    """
    response = requests.post(
        COGNITO_TOKEN_URL,
        data={
            "grant_type": "client_credentials",
            "client_id": COGNITO_CLIENT_ID,
            "client_secret": COGNITO_CLIENT_SECRET,
        },
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    return response.json()["access_token"]
{%- else %}

def _get_access_token():
    """
    Stub implementation if using a custom authorizer.
    """
    raise NotImplementedError("Custom authorizer flow is not implemented.")
{%- endif %}

async def get_streamable_http_mcp_client() -> StreamableHttpMcpToolAdapter:
    gateway_url = os.getenv("GATEWAY_URL")
    if not gateway_url:
        raise RuntimeError("Missing required environment variable: GATEWAY_URL")

    server_params = StreamableHttpServerParams(
        url=f"{gateway_url}/mcp",
        headers={
            "Authorization": f"Bearer {_get_access_token()}"
        }
    )
    return await StreamableHttpMcpToolAdapter.from_server_params(server_params, "AgentCore_Gateway")
