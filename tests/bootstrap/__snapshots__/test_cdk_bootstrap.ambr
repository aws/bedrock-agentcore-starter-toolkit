# serializer version: 1
# name: test_cdk_snapshots[scenario_0][scenario_0-Strands-custom auth; stm+ltm memory; custom headers]
  dict({
    '.bedrock_agentcore.yaml': '''
      default_agent: bootstrap_agent
      is_agentcore_bootstrap_project: true
      agents:
        bootstrap_agent:
          name: bootstrap_agent
          entrypoint: <PROJECT_ROOT>/src
          deployment_type: container
          aws:
            region: null
          bedrock_agentcore:
            agent_id: null
            agent_arn: null
            agent_session_id: null
  
    ''',
    'README.md': '''
      This is a monorepo generated by the agentcore bootstrap CLI tool!
      
      # Deploying
      
      If you want to skip the explanation of the `src/` directory and deploy straight away, see the below cdk/ section.
      
      # Layout
      
      There are three main directories created in this project: `src`, `mcp`, and `cdk`. In a monorepo setup all of the code—source, test, and IaC for deployment—is contained in one repository. Everything needed to
      define runtime code and deploy it into your AWS account is contained in this project.
      
      The `cdk` directory models all of the Bedrock AgentCore and related resources. There are direct references between `cdk` and the runtime `src/`. For example, the IaC code expects to find the
      Dockerfile at a specific relative path.
      
      ## src/
      
      The `src/` directory is where you will find the runtime code.
      
      Start with main entrypoint to the generated app, `src/main.py`. This file defines an agent using Strands and defines an entrypoint method with the Bedrock AgentCore SDK:
      
      ```
      @app.entrypoint
      def invoke(payload):
          # assume payload input is structured as { "prompt": "<user input>" }
      ```
      
      Next there is the `src/mcp_client` directory. Here you will find `client.py`. This file defines an MCP client from the chosen Strands library. That client points to the
      gateway URL for the AgentCore gateway that is modeled in the `cdk` directory. Behind that gateway is a custom MCP tool modeled as a Lambda function (see below `mcp/` section for more details).
      The authorizer for the gateway is the custom authorizer that was passed in `.bedrock_agentcore.yaml`. The `_get_access_token()` method needs to be implemented
      to successfully obtain JWT tokens from your custom authorizer.
      
      ## mcp/
      
      The `mcp/` directory defines a simple Python tool that meets the MCP specification called `placeholder_tool`. The specification for the tool's inputs is defined in the inline schema in the modeled
      `cdk` directory. When replacing the dummy implementation in `mcp/lambda/handler.py`, make sure to update the corresponding Lambda target schema to reflect the changes before re-deploying.
      The `placeholder_tool` implementation demonstrates the tool name and input payload conventions of a Lambda behind the gateway. The gateway supports [flexible target types](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-add-target-api.html).
      
      ## cdk/
      
      This directory contains a CDK project that models AgentCore and related AWS resources.
      
      First check that Node version is >= 18:
      - `node -v` → example output: `v18.19.0`
      - [nvm](https://github.com/nvm-sh/nvm) is a helpful tool to manage Node versions
      
      To deploy your project:
      
      - shorthand: `cd cdk && npm install && npm run cdk synth && npm run cdk:deploy`
      - navigate to the `cdk` directory: `cd cdk`
      - install dependencies: `npm install`
      - synth the CDK project: `npm run cdk synth`
      - deploy all stacks: `npm run cdk:deploy`
      
      # `agentcore bootstrap` output
      
      Primarily, `agentcore bootstrap` outputs the directory that this `README.md` file is contained in. Nothing is deployed into AWS automatically.
      Execute the appropriate deployment commands in the `cdk` directory to deploy.
      
      There is also a `.bedrock_agentcore.yaml` file output in the `testProj` directory. This file contains a minimal definition with your agent name when it is created. After deploying the project, when running
      `agentcore invoke` or `agentcore status`, the command updates `.bedrock_agentcore.yaml` with the ID and ARN of your runtime so the CLI can successfully call the runtime using boto3.
      
      # Invoking the deployed Runtime
      
      The two easiest ways to invoke your runtime after deploying:
      
      1. `agentcore invoke`
         Example:
         ```
         agentcore invoke '{"prompt": "what can you do?"}'
         ```
      
      2. Navigate to the “Test Console” page in the Bedrock AgentCore AWS console. Select your runtime and the `DEFAULT` version. Provide an input.
         Example:
         ```
         {"prompt": "what can you do?"}
         ```
    ''',
    'cdk': None,
    'cdk/.gitignore': '''
      *.js
      !jest.config.js
      *.d.ts
      node_modules
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/.npmignore': '''
      *.ts
      !*.d.ts
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/README': '''
      # Welcome to your CDK TypeScript project
      
      This is a blank project for CDK development with TypeScript.
      
      The `cdk.json` file tells the CDK Toolkit how to execute your app.
      
      ## Useful commands
      
      * `npm run build`   compile typescript to js
      * `npm run watch`   watch for changes and compile
      * `npm run test`    perform the jest unit tests
      * `npx cdk deploy`  deploy this stack to your default AWS account/region
      * `npx cdk diff`    compare deployed stack with current state
      * `npx cdk synth`   emits the synthesized CloudFormation template
    ''',
    'cdk/bin': None,
    'cdk/bin/cdk.ts': '''
      #!/usr/bin/env node
      import * as cdk from 'aws-cdk-lib';
      import { BaseStackProps } from '../lib/types';
      import {
        DockerImageStack,
        AgentCoreStack
      } from '../lib/stacks';
      
      const app = new cdk.App();
      const deploymentProps: BaseStackProps = {
        appName: "testProj",
        /* If you don't specify 'env', this stack will be environment-agnostic.
         * Account/Region-dependent features and context lookups will not work,
         * but a single synthesized template can be deployed anywhere. */
      
        /* Uncomment the next line to specialize this stack for the AWS Account
         * and Region that are implied by the current CLI configuration. */
        // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },
      
        /* Uncomment the next line if you know exactly what Account and Region you
         * want to deploy the stack to. */
        // env: { account: '123456789012', region: 'us-east-1' },
      
        /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
      }
      const dockerImageStack = new DockerImageStack(app, `testProj-DockerImageStack`, deploymentProps);
      const agentCoreStack = new AgentCoreStack(app, `testProj-AgentCoreStack`, {
        ...deploymentProps,
        imageUri: dockerImageStack.imageUri
      });
      agentCoreStack.addDependency(dockerImageStack);
    ''',
    'cdk/cdk.json': '''
      {
        "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
        "watch": {
          "include": [
            "**"
          ],
          "exclude": [
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            "**/*.js",
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
          ]
        },
        "context": {
          "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
          "@aws-cdk/core:checkSecretUsage": true,
          "@aws-cdk/core:target-partitions": [
            "aws",
            "aws-cn"
          ],
          "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
          "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
          "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
          "@aws-cdk/aws-iam:minimizePolicies": true,
          "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
          "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
          "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
          "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
          "@aws-cdk/core:enablePartitionLiterals": true,
          "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
          "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
          "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
          "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
          "@aws-cdk/aws-route53-patters:useCertificate": true,
          "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
          "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
          "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
          "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
          "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
          "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
          "@aws-cdk/aws-redshift:columnId": true,
          "@aws-cdk/aws-stepfunctions-tasks:enableEmrServicePolicyV2": true,
          "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
          "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
          "@aws-cdk/aws-kms:aliasNameRef": true,
          "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
          "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
          "@aws-cdk/aws-efs:denyAnonymousAccess": true,
          "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
          "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
          "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
          "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
          "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
          "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
          "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForCodeCommitSource": true,
          "@aws-cdk/aws-cloudwatch-actions:changeLambdaPermissionLogicalIdForLambdaAction": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeysDefaultValueToFalse": true,
          "@aws-cdk/aws-codepipeline:defaultPipelineTypeToV2": true,
          "@aws-cdk/aws-kms:reduceCrossAccountRegionPolicyScope": true,
          "@aws-cdk/aws-eks:nodegroupNameAttribute": true,
          "@aws-cdk/aws-ec2:ebsDefaultGp3Volume": true,
          "@aws-cdk/aws-ecs:removeDefaultDeploymentAlarm": true,
          "@aws-cdk/custom-resources:logApiResponseDataPropertyTrueDefault": false,
          "@aws-cdk/aws-s3:keepNotificationInImportedBucket": false,
          "@aws-cdk/aws-ecs:enableImdsBlockingDeprecatedFeature": false,
          "@aws-cdk/aws-ecs:disableEcsImdsBlocking": true,
          "@aws-cdk/aws-ecs:reduceEc2FargateCloudWatchPermissions": true,
          "@aws-cdk/aws-dynamodb:resourcePolicyPerReplica": true,
          "@aws-cdk/aws-ec2:ec2SumTImeoutEnabled": true,
          "@aws-cdk/aws-appsync:appSyncGraphQLAPIScopeLambdaPermission": true,
          "@aws-cdk/aws-rds:setCorrectValueForDatabaseInstanceReadReplicaInstanceResourceId": true,
          "@aws-cdk/core:cfnIncludeRejectComplexResourceUpdateCreatePolicyIntrinsics": true,
          "@aws-cdk/aws-lambda-nodejs:sdkV3ExcludeSmithyPackages": true,
          "@aws-cdk/aws-stepfunctions-tasks:fixRunEcsTaskPolicy": true,
          "@aws-cdk/aws-ec2:bastionHostUseAmazonLinux2023ByDefault": true,
          "@aws-cdk/aws-route53-targets:userPoolDomainNameMethodWithoutCustomResource": true,
          "@aws-cdk/aws-elasticloadbalancingV2:albDualstackWithoutPublicIpv4SecurityGroupRulesDefault": true,
          "@aws-cdk/aws-iam:oidcRejectUnauthorizedConnections": true
        }
      }
    ''',
    'cdk/jest.config.js': '''
      module.exports = {
        testEnvironment: 'node',
        roots: ['<rootDir>/test'],
        testMatch: ['**/*.test.ts'],
        transform: {
          '^.+\\.tsx?$': 'ts-jest'
        }
      };
    ''',
    'cdk/lib': None,
    'cdk/lib/stacks': None,
    'cdk/lib/stacks/agentcore-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as bedrockagentcore from 'aws-cdk-lib/aws-bedrockagentcore';
      import * as iam from 'aws-cdk-lib/aws-iam';
      import * as lambda from 'aws-cdk-lib/aws-lambda'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface AgentCoreStackProps extends BaseStackProps {
          imageUri: string
      }
      
      export class AgentCoreStack extends cdk.Stack {
          readonly agentCoreRuntime: bedrockagentcore.CfnRuntime;
          readonly agentCoreGateway: bedrockagentcore.CfnGateway;
          readonly agentCoreMemory: bedrockagentcore.CfnMemory;
          readonly mcpLambda: lambda.Function;
      
          constructor(scope: Construct, id: string, props: AgentCoreStackProps) {
              super(scope, id, props);
      
              const region = cdk.Stack.of(this).region;
              const accountId = cdk.Stack.of(this).account;
              /*****************************
              * AgentCore Gateway
              ******************************/
      
              this.mcpLambda = new lambda.Function(this, `${props.appName}-McpLambda`, {
                  runtime: lambda.Runtime.PYTHON_3_12,
                  handler: "handler.lambda_handler",
                  code: lambda.AssetCode.fromAsset(path.join(__dirname, '../../../mcp/lambda'))
              });
      
              const agentCoreGatewayRole = new iam.Role(this, `${props.appName}-AgentCoreGatewayRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
              });
      
              this.mcpLambda.grantInvoke(agentCoreGatewayRole);
      
              // Create gateway resource
      
              this.agentCoreGateway = new bedrockagentcore.CfnGateway(this, `${props.appName}-AgentCoreGateway`, {
                  name: `${props.appName}-AgentCoreGateway`,
                  protocolType: "MCP",
                  roleArn: agentCoreGatewayRole.roleArn,
                  authorizerType: "CUSTOM_JWT",
                  authorizerConfiguration: {
                      customJwtAuthorizer: {
                      discoveryUrl: "https://aws.dev",
                      allowedClients: ["12345", "6789"],
                      allowedAudience: []
                      },
                  },
              });
      
              new bedrockagentcore.CfnGatewayTarget(this, `${props.appName}-AgentCoreGatewayLambdaTarget`, {
                  name: `${props.appName}-AgentCoreGatewayLambdaTarget`,
                  gatewayIdentifier: this.agentCoreGateway.attrGatewayIdentifier,
                  credentialProviderConfigurations: [
                      {
                          credentialProviderType: "GATEWAY_IAM_ROLE",
                      },
                  ],
                  targetConfiguration: {
                      mcp: {
                          lambda: {
                              lambdaArn: this.mcpLambda.functionArn,
                              toolSchema: {
                                  inlinePayload: [
                                      {
                                          name: "placeholder_tool",
                                          description: "No-op tool that demonstrates passing arguments",
                                          inputSchema: {
                                              type: "object",
                                              properties: {
                                                  string_param: { type: 'string', description: 'Example string parameter' },
                                                  int_param: { type: 'integer', description: 'Example integer parameter' },
                                                  float_array_param: {
                                                      type: 'array',
                                                      description: 'Example float array parameter',
                                                      items: {
                                                          type: 'number',
                                                      }
                                                  }
                                              },
                                              required: []
                                          }
                                      }
                                  ]
                              }
                          }
                      }
                  }
              })
              
              /*****************************
              * AgentCore Memory
              ******************************/
      
              this.agentCoreMemory = new bedrockagentcore.CfnMemory(this, `${props.appName}-AgentCoreMemory`, {
                  name: "bootstrap_agent_memory",
                  eventExpiryDuration: 30,
                  description: "Memory resource with 30 days event expiry",
                  memoryStrategies: [
                      {
                          userPreferenceMemoryStrategy: {
                              name: "UserPreferences",
                              namespaces: ["/users/{actorId}/preferences"],
                              description: "Instance of built-in user preference memory strategy"
                          }
                      },
                      {
                          semanticMemoryStrategy: {
                              name: "SemanticFacts",
                              namespaces: ["/users/{actorId}/facts"],
                              description: "Instance of built-in semantic memory strategy"
                          }
                      },
                      {
                          summaryMemoryStrategy: {
                              name: "SessionSummaries",
                              namespaces: ["/summaries/{actorId}/{sessionId}"],
                              description: "Instance of built-in summary memory strategy"
                          }
                      }
                  ],
              });
              
              /*****************************
              * AgentCore Runtime
              ******************************/
      
              // taken from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-permissions.html#runtime-permissions-execution
              const runtimePolicy = new iam.PolicyDocument({
                  statements: [
                      new iam.PolicyStatement({
                          sid: 'ECRImageAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:BatchGetImage', 'ecr:GetDownloadUrlForLayer'],
                          resources: [
                              `arn:aws:ecr:${region}:${accountId}:repository/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogStreams', 'logs:CreateLogGroup'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogGroups'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'ECRTokenAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:GetAuthorizationToken'],
                          resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'xray:PutTraceSegments',
                              'xray:PutTelemetryRecords',
                              'xray:GetSamplingRules',
                              'xray:GetSamplingTargets',
                          ],
                      resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['cloudwatch:PutMetricData'],
                          resources: ['*'],
                          conditions: {
                              StringEquals: { 'cloudwatch:namespace': 'bedrock-agentcore' },
                          },
                      }),
                      new iam.PolicyStatement({
                          sid: 'GetAgentAccessToken',
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'bedrock-agentcore:GetWorkloadAccessToken',
                              'bedrock-agentcore:GetWorkloadAccessTokenForJWT',
                              'bedrock-agentcore:GetWorkloadAccessTokenForUserId',
                          ],
                          resources: [
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default`,
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default/workload-identity/agentName-*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'BedrockModelInvocation',
                          effect: iam.Effect.ALLOW,
                          actions: ['bedrock:InvokeModel', 'bedrock:InvokeModelWithResponseStream'],
                          resources: [
                              `arn:aws:bedrock:*::foundation-model/*`,
                              `arn:aws:bedrock:${region}:${accountId}:*`,
                          ],
                      }),
                  ],
              });
      
              const runtimeRole = new iam.Role(this, `${props.appName}-AgentCoreRuntimeRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
                  inlinePolicies: {
                      RuntimeAccessPolicy: runtimePolicy
                  }
              });
      
              this.agentCoreRuntime = new bedrockagentcore.CfnRuntime(this, `${props.appName}-AgentCoreRuntime`, {
                  agentRuntimeArtifact: {
                      containerConfiguration: {
                          containerUri: props.imageUri
                      }
                  },
                  agentRuntimeName: "bootstrap_agent",
                  protocolConfiguration: "HTTP",
                  networkConfiguration: {
                      networkMode: "PUBLIC"
                  },
                  roleArn: runtimeRole.roleArn,
                  environmentVariables: {
                      "GATEWAY_URL": this.agentCoreGateway.attrGatewayUrl,
                      "MEMORY_ID":  this.agentCoreMemory.attrMemoryId,
                  },
                  authorizerConfiguration: {
                      customJwtAuthorizer: {
                          discoveryUrl: "https://aws.dev",
                          allowedClients: ["12345", "6789"],
                          allowedAudience: []
                      }
                  }
              });
      
              // DEFAULT endpoint always points to newest published version. Optionally, can use these versioned endpoints below
              // https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agent-runtime-versioning.html
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeProdEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "PROD"
              });
      
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeDevEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "DEV"
              });
          }
      }
    ''',
    'cdk/lib/stacks/docker-image-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as ecr_assets from 'aws-cdk-lib/aws-ecr-assets'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface DockerImageStackProps extends BaseStackProps {}
      
      export class DockerImageStack extends cdk.Stack {
          readonly imageUri: string
      
          constructor(scope: Construct, id: string, props: DockerImageStackProps) {
              super(scope, id, props);
      
              const asset = new ecr_assets.DockerImageAsset(this, `${props.appName}-AppImage`, {
                  directory: path.join(__dirname, "../../../src/"), // path to root of the project
              });
      
              this.imageUri = asset.imageUri;
              new cdk.CfnOutput(this, 'ImageUri', { value: this.imageUri });
          }
      }
    ''',
    'cdk/lib/stacks/index.ts': '''
      export * from './docker-image-stack';
      export * from './agentcore-stack';
    ''',
    'cdk/lib/test': None,
    'cdk/lib/test/cdk.test.ts': '''
      // import * as cdk from 'aws-cdk-lib';
      // import { Template } from 'aws-cdk-lib/assertions';
      // import * as Cdk from '../lib/cdk-stack';
      
      // example test. To run these tests, uncomment this file along with the
      // example resource in lib/cdk-stack.ts
      test('SQS Queue Created', () => {
      //   const app = new cdk.App();
      //     // WHEN
      //   const stack = new Cdk.CdkStack(app, 'MyTestStack');
      //     // THEN
      //   const template = Template.fromStack(stack);
      
      //   template.hasResourceProperties('AWS::SQS::Queue', {
      //     VisibilityTimeout: 300
      //   });
      });
    ''',
    'cdk/lib/types.ts': '''
      import * as cdk from 'aws-cdk-lib/core'
      
      export interface BaseStackProps extends cdk.StackProps {
          appName: string
      }
    ''',
    'cdk/package.json': '''
      {
        "name": "cdk",
        "version": "0.1.0",
        "bin": {
          "cdk": "bin/cdk.js"
        },
        "engines": {
          "node": ">=18.0.0"
        },
        "scripts": {
          "build": "tsc",
          "watch": "tsc -w",
          "test": "jest",
          "cdk": "cdk",
          "cdk:deploy": "cdk deploy --all",
          "cdk:deploy:ci": "cdk deploy --all --require-approval never"
        },
        "devDependencies": {
          "@types/jest": "^29.5.14",
          "@types/node": "22.7.9",
          "aws-cdk": "^2.1031.1",
          "jest": "^29.7.0",
          "ts-jest": "^29.2.5",
          "ts-node": "^10.9.2",
          "typescript": "~5.6.3"
        },
        "dependencies": {
          "aws-cdk-lib": "^2.221.1",
          "constructs": "^10.4.2"
        }
      }
    ''',
    'cdk/tsconfig.json': '''
      {
        "compilerOptions": {
          "target": "ES2020",
          "module": "commonjs",
          "lib": [
            "es2020",
            "dom"
          ],
          "declaration": true,
          "strict": true,
          "noImplicitAny": true,
          "strictNullChecks": true,
          "noImplicitThis": true,
          "alwaysStrict": true,
          "noUnusedLocals": false,
          "noUnusedParameters": false,
          "noImplicitReturns": true,
          "noFallthroughCasesInSwitch": false,
          "inlineSourceMap": true,
          "inlineSources": true,
          "experimentalDecorators": true,
          "strictPropertyInitialization": false,
          "typeRoots": [
            "./node_modules/@types"
          ]
        },
        "exclude": [
          "node_modules",
          "cdk.out"
        ]
      }
    ''',
    'invoke_local_server.py': '''
      import subprocess
      import sys
      
      if len(sys.argv) < 2:
          print("usage: python invoke_local_server.py 'your prompt'")
          sys.exit(1)
      
      prompt = sys.argv[1]
      
      subprocess.run([
          "curl",
          "-X", "POST",
          "http://127.0.0.1:8000/invocations",
          "-H", "Content-Type: application/json",
      
          "-d", f'{{"payload": {{"prompt": "{prompt}"}}}}'
      
      ])
    ''',
    'mcp': None,
    'mcp/lambda': None,
    'mcp/lambda/handler.py': '''
      import json
      from typing import Any, Dict
      
      
      def lambda_handler(event, context):
          """
          Generic Lambda handler for Bedrock AgentCore Gateway placeholder tool.
      
          Expected input:
              event: {
                  # optional tool arguments
                  "param_0": val0,
                  "param_1": val1,
                  ...
              }
      
          Context should contain:
              context.client_context.custom["bedrockAgentCoreToolName"]
              → e.g. "LambdaTarget___placeholder_tool"
          """
          try:
              extended_name = context.client_context.custom.get("bedrockAgentCoreToolName")
              tool_name = None
      
              # handle agentcore gateway tool naming convention
              # https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-tool-naming.html
              if extended_name and "___" in extended_name:
                  tool_name = extended_name.split("___", 1)[1]
      
              if not tool_name:
                  return _response(400, {"error": "Missing tool name"})
      
              if tool_name != "placeholder_tool":
                  return _response(400, {"error": f"Unknown tool '{tool_name}'"})
      
              result = placeholder_tool(event)
              return _response(200, {"result": result})
      
          except Exception as e:
              return _response(500, {"system_error": str(e)})
      
      
      def _response(status_code: int, body: Dict[str, Any]):
          """Consistent JSON response wrapper."""
          return {"statusCode": status_code, "body": json.dumps(body)}
      
      
      def placeholder_tool(event: Dict[str, Any]):
          """
          no-op placeholder tool.
      
          Demonstrates argument passing from AgentCore Gateway.
          """
          return {
              "message": "Placeholder tool executed.",
              "string_param": event.get("string_param"),
              "int_param": event.get("int_param"),
              "float_array_param": event.get("float_array_param"),
              "event_args_received": event,
          }
    ''',
    'run_local_server.py': '''
      import uvicorn
      
      """
      Runs the entrypoint as a local uvicorn app with hot-reloading. If the app is configured to hit a remote MCP behind a gateway,
      first deploy the application.
      """
      
      if __name__ == "__main__":
          uvicorn.run(
              "src.main:app",
              host="127.0.0.1",
              port=8000,
              reload=True,
          )
    ''',
    'src': None,
    'src/.dockerignore': '''
      # Build artifacts
      build/
      dist/
      *.egg-info/
      *.egg
      
      # Python cache
      __pycache__/
      __pycache__*
      *.py[cod]
      *$py.class
      *.so
      .Python
      
      # Virtual environments
      .venv/
      .env
      venv/
      env/
      ENV/
      
      # Testing
      .pytest_cache/
      .coverage
      .coverage*
      htmlcov/
      .tox/
      *.cover
      .hypothesis/
      .mypy_cache/
      .ruff_cache/
      
      # Development
      *.log
      *.bak
      *.swp
      *.swo
      *~
      .DS_Store
      
      # IDEs
      .vscode/
      .idea/
      
      # Version control
      .git/
      .gitignore
      .gitattributes
      
      # Documentation
      docs/
      
      # CI/CD
      .github/
      .gitlab-ci.yml
      .travis.yml
      
      # Project specific
      tests/
      
      # Bedrock AgentCore specific - keep config but exclude runtime files
      .bedrock_agentcore.yaml
      .dockerignore
      .bedrock_agentcore/
      
      # Keep wheelhouse for offline installations
      # wheelhouse/
      
      # Monorepo directories
      cdk/
      terraform/
  
    ''',
    'src/Dockerfile': '''
      FROM ghcr.io/astral-sh/uv:python3.10-bookworm-slim
      WORKDIR /app
      
      # All environment variables in one layer
      ENV UV_SYSTEM_PYTHON=1 \
          UV_COMPILE_BYTECODE=1 \
          UV_NO_PROGRESS=1 \
          PYTHONUNBUFFERED=1 \
          DOCKER_CONTAINER=1
      
      
      
      COPY pyproject.toml pyproject.toml
      # Install from requirements file
      RUN uv pip install -r pyproject.toml
      
      
      
      
      RUN uv pip install aws-opentelemetry-distro>=0.10.1
      
      
      # Signal that this is running in Docker for host binding logic
      ENV DOCKER_CONTAINER=1
      
      # Create non-root user
      RUN useradd -m -u 1000 bedrock_agentcore
      USER bedrock_agentcore
      
      EXPOSE 9000
      EXPOSE 8000
      EXPOSE 8080
      
      # Copy entire project (respecting .dockerignore)
      COPY . .
      
      # Use the full module path
      
      CMD ["opentelemetry-instrument", "python", "-m", "main"]
  
    ''',
    'src/main.py': '''
      from strands import Agent, tool
      from bedrock_agentcore import BedrockAgentCoreApp
      from mcp_client.client import get_streamable_http_mcp_client
      
      # Import AgentCore Gateway as Streamable HTTP MCP Client
      mcp_client = get_streamable_http_mcp_client()
      
      # Define a simple function tool
      @tool
      def add_numbers(a: int, b: int) -> int:
          """Return the sum of two numbers"""
          return a+b
      
      # Integrate with Bedrock AgentCore
      app = BedrockAgentCoreApp()
      
      @app.entrypoint
      def invoke(payload):
          # assume payload input is structured as { "prompt": "<user input>" }
      
          # Create an Agent with MCP tools
          with mcp_client:
              # Create an Agent with MCP tools
              tools = mcp_client.list_tools_sync()
              agent = Agent(tools=tools + [add_numbers])
      
              # Process the user prompt
              prompt = payload.get("prompt", "What is Agentic AI?")
      
              # Run the agent
              response = agent(prompt)
      
              # Return result
              return {
                  "response": response
              }
      
      if __name__ == "__main__":
          app.run()
    ''',
    'src/mcp_client': None,
    'src/mcp_client/client.py': '''
      import os
      from mcp.client.streamable_http import streamablehttp_client
      from strands.tools.mcp.mcp_client import MCPClient
      
      def _get_access_token():
          """
          Stub implementation if using a custom authorizer.
          """
          raise NotImplementedError("Custom authorizer flow is not implemented.")
      
      
      def get_streamable_http_mcp_client() -> MCPClient:
          """
          Returns an MCP Client for AgentCore Gateway compatible with Strands
          """
          gateway_url = os.getenv("GATEWAY_URL")
          if not gateway_url:
              raise RuntimeError("Missing required environment variable: GATEWAY_URL")
          access_token = _get_access_token()
          return MCPClient(lambda: streamablehttp_client(gateway_url, headers={"Authorization": f"Bearer {access_token}"}))
    ''',
    'src/pyproject.toml': '''
      [build-system]
      requires = ["setuptools>=68", "wheel"]
      build-backend = "setuptools.build_meta"
      
      [project]
      name = "testProj"
      version = "0.1.0"
      requires-python = ">=3.10"
      
      dependencies = [
          "bedrock-agentcore >= 1.0.3",
          "mcp >= 1.19.0",
          "requests >= 2.32.5",
          "strands-agents >= 1.13.0"
      ]
    ''',
  })
# ---
# name: test_cdk_snapshots[scenario_1][scenario_1-OpenAIAgents-default settings; stm memory]
  dict({
    '.bedrock_agentcore.yaml': '''
      default_agent: bootstrap_agent
      is_agentcore_bootstrap_project: true
      agents:
        bootstrap_agent:
          name: bootstrap_agent
          entrypoint: <PROJECT_ROOT>/src
          deployment_type: container
          aws:
            region: null
          bedrock_agentcore:
            agent_id: null
            agent_arn: null
            agent_session_id: null
  
    ''',
    'README.md': '''
      This is a monorepo generated by the agentcore bootstrap CLI tool!
      
      # Deploying
      
      If you want to skip the explanation of the `src/` directory and deploy straight away, see the below cdk/ section.
      
      # Layout
      
      There are three main directories created in this project: `src`, `mcp`, and `cdk`. In a monorepo setup all of the code—source, test, and IaC for deployment—is contained in one repository. Everything needed to
      define runtime code and deploy it into your AWS account is contained in this project.
      
      The `cdk` directory models all of the Bedrock AgentCore and related resources. There are direct references between `cdk` and the runtime `src/`. For example, the IaC code expects to find the
      Dockerfile at a specific relative path.
      
      ## src/
      
      The `src/` directory is where you will find the runtime code.
      
      Start with main entrypoint to the generated app, `src/main.py`. This file defines an agent using OpenAIAgents and defines an entrypoint method with the Bedrock AgentCore SDK:
      
      ```
      @app.entrypoint
      def invoke(payload):
          # assume payload input is structured as { "prompt": "<user input>" }
      ```
      
      Next there is the `src/mcp_client` directory. Here you will find `client.py`. This file defines an MCP client from the chosen OpenAIAgents library. That client points to the
      gateway URL for the AgentCore gateway that is modeled in the `cdk` directory. Behind that gateway is a custom MCP tool modeled as a Lambda function (see below `mcp/` section for more details).
      The authorizer for the gateway is a Cognito app client that is modeled in the `cdk` directory. A call using
      the client_credentials flow is defined in `_get_access_token()`.
      
      ## mcp/
      
      The `mcp/` directory defines a simple Python tool that meets the MCP specification called `placeholder_tool`. The specification for the tool's inputs is defined in the inline schema in the modeled
      `cdk` directory. When replacing the dummy implementation in `mcp/lambda/handler.py`, make sure to update the corresponding Lambda target schema to reflect the changes before re-deploying.
      The `placeholder_tool` implementation demonstrates the tool name and input payload conventions of a Lambda behind the gateway. The gateway supports [flexible target types](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-add-target-api.html).
      
      ## cdk/
      
      This directory contains a CDK project that models AgentCore and related AWS resources.
      
      First check that Node version is >= 18:
      - `node -v` → example output: `v18.19.0`
      - [nvm](https://github.com/nvm-sh/nvm) is a helpful tool to manage Node versions
      
      To deploy your project:
      
      - shorthand: `cd cdk && npm install && npm run cdk synth && npm run cdk:deploy`
      - navigate to the `cdk` directory: `cd cdk`
      - install dependencies: `npm install`
      - synth the CDK project: `npm run cdk synth`
      - deploy all stacks: `npm run cdk:deploy`
      
      # `agentcore bootstrap` output
      
      Primarily, `agentcore bootstrap` outputs the directory that this `README.md` file is contained in. Nothing is deployed into AWS automatically.
      Execute the appropriate deployment commands in the `cdk` directory to deploy.
      
      There is also a `.bedrock_agentcore.yaml` file output in the `testProj` directory. This file contains a minimal definition with your agent name when it is created. After deploying the project, when running
      `agentcore invoke` or `agentcore status`, the command updates `.bedrock_agentcore.yaml` with the ID and ARN of your runtime so the CLI can successfully call the runtime using boto3.
      
      # Invoking the deployed Runtime
      
      The two easiest ways to invoke your runtime after deploying:
      
      1. `agentcore invoke`
         Example:
         ```
         agentcore invoke '{"prompt": "what can you do?"}'
         ```
      
      2. Navigate to the “Test Console” page in the Bedrock AgentCore AWS console. Select your runtime and the `DEFAULT` version. Provide an input.
         Example:
         ```
         {"prompt": "what can you do?"}
         ```
    ''',
    'cdk': None,
    'cdk/.gitignore': '''
      *.js
      !jest.config.js
      *.d.ts
      node_modules
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/.npmignore': '''
      *.ts
      !*.d.ts
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/README': '''
      # Welcome to your CDK TypeScript project
      
      This is a blank project for CDK development with TypeScript.
      
      The `cdk.json` file tells the CDK Toolkit how to execute your app.
      
      ## Useful commands
      
      * `npm run build`   compile typescript to js
      * `npm run watch`   watch for changes and compile
      * `npm run test`    perform the jest unit tests
      * `npx cdk deploy`  deploy this stack to your default AWS account/region
      * `npx cdk diff`    compare deployed stack with current state
      * `npx cdk synth`   emits the synthesized CloudFormation template
    ''',
    'cdk/bin': None,
    'cdk/bin/cdk.ts': '''
      #!/usr/bin/env node
      import * as cdk from 'aws-cdk-lib';
      import { BaseStackProps } from '../lib/types';
      import {
        DockerImageStack,
        AgentCoreStack
      } from '../lib/stacks';
      
      const app = new cdk.App();
      const deploymentProps: BaseStackProps = {
        appName: "testProj",
        /* If you don't specify 'env', this stack will be environment-agnostic.
         * Account/Region-dependent features and context lookups will not work,
         * but a single synthesized template can be deployed anywhere. */
      
        /* Uncomment the next line to specialize this stack for the AWS Account
         * and Region that are implied by the current CLI configuration. */
        // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },
      
        /* Uncomment the next line if you know exactly what Account and Region you
         * want to deploy the stack to. */
        // env: { account: '123456789012', region: 'us-east-1' },
      
        /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
      }
      const dockerImageStack = new DockerImageStack(app, `testProj-DockerImageStack`, deploymentProps);
      const agentCoreStack = new AgentCoreStack(app, `testProj-AgentCoreStack`, {
        ...deploymentProps,
        imageUri: dockerImageStack.imageUri
      });
      agentCoreStack.addDependency(dockerImageStack);
    ''',
    'cdk/cdk.json': '''
      {
        "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
        "watch": {
          "include": [
            "**"
          ],
          "exclude": [
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            "**/*.js",
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
          ]
        },
        "context": {
          "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
          "@aws-cdk/core:checkSecretUsage": true,
          "@aws-cdk/core:target-partitions": [
            "aws",
            "aws-cn"
          ],
          "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
          "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
          "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
          "@aws-cdk/aws-iam:minimizePolicies": true,
          "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
          "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
          "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
          "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
          "@aws-cdk/core:enablePartitionLiterals": true,
          "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
          "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
          "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
          "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
          "@aws-cdk/aws-route53-patters:useCertificate": true,
          "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
          "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
          "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
          "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
          "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
          "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
          "@aws-cdk/aws-redshift:columnId": true,
          "@aws-cdk/aws-stepfunctions-tasks:enableEmrServicePolicyV2": true,
          "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
          "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
          "@aws-cdk/aws-kms:aliasNameRef": true,
          "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
          "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
          "@aws-cdk/aws-efs:denyAnonymousAccess": true,
          "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
          "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
          "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
          "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
          "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
          "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
          "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForCodeCommitSource": true,
          "@aws-cdk/aws-cloudwatch-actions:changeLambdaPermissionLogicalIdForLambdaAction": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeysDefaultValueToFalse": true,
          "@aws-cdk/aws-codepipeline:defaultPipelineTypeToV2": true,
          "@aws-cdk/aws-kms:reduceCrossAccountRegionPolicyScope": true,
          "@aws-cdk/aws-eks:nodegroupNameAttribute": true,
          "@aws-cdk/aws-ec2:ebsDefaultGp3Volume": true,
          "@aws-cdk/aws-ecs:removeDefaultDeploymentAlarm": true,
          "@aws-cdk/custom-resources:logApiResponseDataPropertyTrueDefault": false,
          "@aws-cdk/aws-s3:keepNotificationInImportedBucket": false,
          "@aws-cdk/aws-ecs:enableImdsBlockingDeprecatedFeature": false,
          "@aws-cdk/aws-ecs:disableEcsImdsBlocking": true,
          "@aws-cdk/aws-ecs:reduceEc2FargateCloudWatchPermissions": true,
          "@aws-cdk/aws-dynamodb:resourcePolicyPerReplica": true,
          "@aws-cdk/aws-ec2:ec2SumTImeoutEnabled": true,
          "@aws-cdk/aws-appsync:appSyncGraphQLAPIScopeLambdaPermission": true,
          "@aws-cdk/aws-rds:setCorrectValueForDatabaseInstanceReadReplicaInstanceResourceId": true,
          "@aws-cdk/core:cfnIncludeRejectComplexResourceUpdateCreatePolicyIntrinsics": true,
          "@aws-cdk/aws-lambda-nodejs:sdkV3ExcludeSmithyPackages": true,
          "@aws-cdk/aws-stepfunctions-tasks:fixRunEcsTaskPolicy": true,
          "@aws-cdk/aws-ec2:bastionHostUseAmazonLinux2023ByDefault": true,
          "@aws-cdk/aws-route53-targets:userPoolDomainNameMethodWithoutCustomResource": true,
          "@aws-cdk/aws-elasticloadbalancingV2:albDualstackWithoutPublicIpv4SecurityGroupRulesDefault": true,
          "@aws-cdk/aws-iam:oidcRejectUnauthorizedConnections": true
        }
      }
    ''',
    'cdk/jest.config.js': '''
      module.exports = {
        testEnvironment: 'node',
        roots: ['<rootDir>/test'],
        testMatch: ['**/*.test.ts'],
        transform: {
          '^.+\\.tsx?$': 'ts-jest'
        }
      };
    ''',
    'cdk/lib': None,
    'cdk/lib/stacks': None,
    'cdk/lib/stacks/agentcore-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as bedrockagentcore from 'aws-cdk-lib/aws-bedrockagentcore';
      import * as iam from 'aws-cdk-lib/aws-iam';
      import * as lambda from 'aws-cdk-lib/aws-lambda'
      import * as cognito from 'aws-cdk-lib/aws-cognito';
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface AgentCoreStackProps extends BaseStackProps {
          imageUri: string
      }
      
      export class AgentCoreStack extends cdk.Stack {
          readonly agentCoreRuntime: bedrockagentcore.CfnRuntime;
          readonly agentCoreGateway: bedrockagentcore.CfnGateway;
          readonly agentCoreMemory: bedrockagentcore.CfnMemory;
          readonly mcpLambda: lambda.Function;
      
          constructor(scope: Construct, id: string, props: AgentCoreStackProps) {
              super(scope, id, props);
      
              const region = cdk.Stack.of(this).region;
              const accountId = cdk.Stack.of(this).account;
              /*****************************
              * AgentCore Gateway
              ******************************/
      
              this.mcpLambda = new lambda.Function(this, `${props.appName}-McpLambda`, {
                  runtime: lambda.Runtime.PYTHON_3_12,
                  handler: "handler.lambda_handler",
                  code: lambda.AssetCode.fromAsset(path.join(__dirname, '../../../mcp/lambda'))
              });
      
              const agentCoreGatewayRole = new iam.Role(this, `${props.appName}-AgentCoreGatewayRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
              });
      
              this.mcpLambda.grantInvoke(agentCoreGatewayRole);
      
              // Create gateway resource
              // Cognito resources
              const cognitoUserPool = new cognito.UserPool(this, `${props.appName}-CognitoUserPool`);
      
              // create resource server to work with client credentials auth flow
              const cognitoResourceServerScope = {
                  scopeName: 'basic',
                  scopeDescription: 'Basic access to testProj',
              };
      
              const cognitoResourceServer = cognitoUserPool.addResourceServer(`${props.appName}-CognitoResourceServer`, {
                  identifier: `${props.appName}-CognitoResourceServer`,
                  scopes: [cognitoResourceServerScope],
              });
      
              const cognitoAppClient = new cognito.UserPoolClient(this, `${props.appName}-CognitoAppClient`, {
                  userPool: cognitoUserPool,
                  generateSecret: true,
                  oAuth: {
                      flows: {
                          clientCredentials: true,
                      },
                      scopes: [cognito.OAuthScope.resourceServer(cognitoResourceServer, cognitoResourceServerScope)],
                  },
                  supportedIdentityProviders: [cognito.UserPoolClientIdentityProvider.COGNITO],
              });
              const cognitoDomain = cognitoUserPool.addDomain(`${props.appName}-CognitoDomain`, {
                  cognitoDomain: {
                      domainPrefix: `${props.appName}-${region}`,
                  },
              });
              const cognitoTokenUrl = cognitoDomain.baseUrl() + '/oauth2/token';
      
              this.agentCoreGateway = new bedrockagentcore.CfnGateway(this, `${props.appName}-AgentCoreGateway`, {
                  name: `${props.appName}-AgentCoreGateway`,
                  protocolType: "MCP",
                  roleArn: agentCoreGatewayRole.roleArn,
                  authorizerType: "CUSTOM_JWT",
                  authorizerConfiguration: {
                      customJwtAuthorizer: {
                      discoveryUrl:
                          'https://cognito-idp.' +
                          region +
                          '.amazonaws.com/' +
                          cognitoUserPool.userPoolId +
                          '/.well-known/openid-configuration',
                      allowedClients: [cognitoAppClient.userPoolClientId],
                      },
                  },
              });
      
              new bedrockagentcore.CfnGatewayTarget(this, `${props.appName}-AgentCoreGatewayLambdaTarget`, {
                  name: `${props.appName}-AgentCoreGatewayLambdaTarget`,
                  gatewayIdentifier: this.agentCoreGateway.attrGatewayIdentifier,
                  credentialProviderConfigurations: [
                      {
                          credentialProviderType: "GATEWAY_IAM_ROLE",
                      },
                  ],
                  targetConfiguration: {
                      mcp: {
                          lambda: {
                              lambdaArn: this.mcpLambda.functionArn,
                              toolSchema: {
                                  inlinePayload: [
                                      {
                                          name: "placeholder_tool",
                                          description: "No-op tool that demonstrates passing arguments",
                                          inputSchema: {
                                              type: "object",
                                              properties: {
                                                  string_param: { type: 'string', description: 'Example string parameter' },
                                                  int_param: { type: 'integer', description: 'Example integer parameter' },
                                                  float_array_param: {
                                                      type: 'array',
                                                      description: 'Example float array parameter',
                                                      items: {
                                                          type: 'number',
                                                      }
                                                  }
                                              },
                                              required: []
                                          }
                                      }
                                  ]
                              }
                          }
                      }
                  }
              })
              
              /*****************************
              * AgentCore Memory
              ******************************/
      
              this.agentCoreMemory = new bedrockagentcore.CfnMemory(this, `${props.appName}-AgentCoreMemory`, {
                  name: "bootstrap_agent_memory",
                  eventExpiryDuration: 30,
                  description: "Memory resource with 30 days event expiry",
                  memoryStrategies: [
                      // can take a built-in strategy from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/built-in-strategies.html or define a custom one
                  ],
              });
              
              /*****************************
              * AgentCore Runtime
              ******************************/
      
              // taken from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-permissions.html#runtime-permissions-execution
              const runtimePolicy = new iam.PolicyDocument({
                  statements: [
                      new iam.PolicyStatement({
                          sid: 'ECRImageAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:BatchGetImage', 'ecr:GetDownloadUrlForLayer'],
                          resources: [
                              `arn:aws:ecr:${region}:${accountId}:repository/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogStreams', 'logs:CreateLogGroup'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogGroups'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'ECRTokenAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:GetAuthorizationToken'],
                          resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'xray:PutTraceSegments',
                              'xray:PutTelemetryRecords',
                              'xray:GetSamplingRules',
                              'xray:GetSamplingTargets',
                          ],
                      resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['cloudwatch:PutMetricData'],
                          resources: ['*'],
                          conditions: {
                              StringEquals: { 'cloudwatch:namespace': 'bedrock-agentcore' },
                          },
                      }),
                      new iam.PolicyStatement({
                          sid: 'GetAgentAccessToken',
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'bedrock-agentcore:GetWorkloadAccessToken',
                              'bedrock-agentcore:GetWorkloadAccessTokenForJWT',
                              'bedrock-agentcore:GetWorkloadAccessTokenForUserId',
                          ],
                          resources: [
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default`,
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default/workload-identity/agentName-*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'BedrockModelInvocation',
                          effect: iam.Effect.ALLOW,
                          actions: ['bedrock:InvokeModel', 'bedrock:InvokeModelWithResponseStream'],
                          resources: [
                              `arn:aws:bedrock:*::foundation-model/*`,
                              `arn:aws:bedrock:${region}:${accountId}:*`,
                          ],
                      }),
                  ],
              });
      
              const runtimeRole = new iam.Role(this, `${props.appName}-AgentCoreRuntimeRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
                  inlinePolicies: {
                      RuntimeAccessPolicy: runtimePolicy
                  }
              });
      
              this.agentCoreRuntime = new bedrockagentcore.CfnRuntime(this, `${props.appName}-AgentCoreRuntime`, {
                  agentRuntimeArtifact: {
                      containerConfiguration: {
                          containerUri: props.imageUri
                      }
                  },
                  agentRuntimeName: "bootstrap_agent",
                  protocolConfiguration: "HTTP",
                  networkConfiguration: {
                      networkMode: "PUBLIC"
                  },
                  roleArn: runtimeRole.roleArn,
                  environmentVariables: {
                      "GATEWAY_URL": this.agentCoreGateway.attrGatewayUrl,
                      "MEMORY_ID":  this.agentCoreMemory.attrMemoryId,
                      "COGNITO_CLIENT_ID": cognitoAppClient.userPoolClientId,
                      "COGNITO_CLIENT_SECRET": cognitoAppClient.userPoolClientSecret.unsafeUnwrap(), // alternatives to consider: agentcore identity (no cdk constructs yet) or secrets manager
                      "COGNITO_TOKEN_URL": cognitoTokenUrl,
                      "COGNITO_SCOPE": `${cognitoResourceServer.userPoolResourceServerId}/${cognitoResourceServerScope.scopeName}`
                  }
              });
      
              // DEFAULT endpoint always points to newest published version. Optionally, can use these versioned endpoints below
              // https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agent-runtime-versioning.html
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeProdEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "PROD"
              });
      
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeDevEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "DEV"
              });
          }
      }
    ''',
    'cdk/lib/stacks/docker-image-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as ecr_assets from 'aws-cdk-lib/aws-ecr-assets'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface DockerImageStackProps extends BaseStackProps {}
      
      export class DockerImageStack extends cdk.Stack {
          readonly imageUri: string
      
          constructor(scope: Construct, id: string, props: DockerImageStackProps) {
              super(scope, id, props);
      
              const asset = new ecr_assets.DockerImageAsset(this, `${props.appName}-AppImage`, {
                  directory: path.join(__dirname, "../../../src/"), // path to root of the project
              });
      
              this.imageUri = asset.imageUri;
              new cdk.CfnOutput(this, 'ImageUri', { value: this.imageUri });
          }
      }
    ''',
    'cdk/lib/stacks/index.ts': '''
      export * from './docker-image-stack';
      export * from './agentcore-stack';
    ''',
    'cdk/lib/test': None,
    'cdk/lib/test/cdk.test.ts': '''
      // import * as cdk from 'aws-cdk-lib';
      // import { Template } from 'aws-cdk-lib/assertions';
      // import * as Cdk from '../lib/cdk-stack';
      
      // example test. To run these tests, uncomment this file along with the
      // example resource in lib/cdk-stack.ts
      test('SQS Queue Created', () => {
      //   const app = new cdk.App();
      //     // WHEN
      //   const stack = new Cdk.CdkStack(app, 'MyTestStack');
      //     // THEN
      //   const template = Template.fromStack(stack);
      
      //   template.hasResourceProperties('AWS::SQS::Queue', {
      //     VisibilityTimeout: 300
      //   });
      });
    ''',
    'cdk/lib/types.ts': '''
      import * as cdk from 'aws-cdk-lib/core'
      
      export interface BaseStackProps extends cdk.StackProps {
          appName: string
      }
    ''',
    'cdk/package.json': '''
      {
        "name": "cdk",
        "version": "0.1.0",
        "bin": {
          "cdk": "bin/cdk.js"
        },
        "engines": {
          "node": ">=18.0.0"
        },
        "scripts": {
          "build": "tsc",
          "watch": "tsc -w",
          "test": "jest",
          "cdk": "cdk",
          "cdk:deploy": "cdk deploy --all",
          "cdk:deploy:ci": "cdk deploy --all --require-approval never"
        },
        "devDependencies": {
          "@types/jest": "^29.5.14",
          "@types/node": "22.7.9",
          "aws-cdk": "^2.1031.1",
          "jest": "^29.7.0",
          "ts-jest": "^29.2.5",
          "ts-node": "^10.9.2",
          "typescript": "~5.6.3"
        },
        "dependencies": {
          "aws-cdk-lib": "^2.221.1",
          "constructs": "^10.4.2"
        }
      }
    ''',
    'cdk/tsconfig.json': '''
      {
        "compilerOptions": {
          "target": "ES2020",
          "module": "commonjs",
          "lib": [
            "es2020",
            "dom"
          ],
          "declaration": true,
          "strict": true,
          "noImplicitAny": true,
          "strictNullChecks": true,
          "noImplicitThis": true,
          "alwaysStrict": true,
          "noUnusedLocals": false,
          "noUnusedParameters": false,
          "noImplicitReturns": true,
          "noFallthroughCasesInSwitch": false,
          "inlineSourceMap": true,
          "inlineSources": true,
          "experimentalDecorators": true,
          "strictPropertyInitialization": false,
          "typeRoots": [
            "./node_modules/@types"
          ]
        },
        "exclude": [
          "node_modules",
          "cdk.out"
        ]
      }
    ''',
    'invoke_local_server.py': '''
      import subprocess
      import sys
      
      if len(sys.argv) < 2:
          print("usage: python invoke_local_server.py 'your prompt'")
          sys.exit(1)
      
      prompt = sys.argv[1]
      
      subprocess.run([
          "curl",
          "-X", "POST",
          "http://127.0.0.1:8000/invocations",
          "-H", "Content-Type: application/json",
      
          "-d", f'{{"payload": {{"prompt": "{prompt}"}}}}'
      
      ])
    ''',
    'mcp': None,
    'mcp/lambda': None,
    'mcp/lambda/handler.py': '''
      import json
      from typing import Any, Dict
      
      
      def lambda_handler(event, context):
          """
          Generic Lambda handler for Bedrock AgentCore Gateway placeholder tool.
      
          Expected input:
              event: {
                  # optional tool arguments
                  "param_0": val0,
                  "param_1": val1,
                  ...
              }
      
          Context should contain:
              context.client_context.custom["bedrockAgentCoreToolName"]
              → e.g. "LambdaTarget___placeholder_tool"
          """
          try:
              extended_name = context.client_context.custom.get("bedrockAgentCoreToolName")
              tool_name = None
      
              # handle agentcore gateway tool naming convention
              # https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-tool-naming.html
              if extended_name and "___" in extended_name:
                  tool_name = extended_name.split("___", 1)[1]
      
              if not tool_name:
                  return _response(400, {"error": "Missing tool name"})
      
              if tool_name != "placeholder_tool":
                  return _response(400, {"error": f"Unknown tool '{tool_name}'"})
      
              result = placeholder_tool(event)
              return _response(200, {"result": result})
      
          except Exception as e:
              return _response(500, {"system_error": str(e)})
      
      
      def _response(status_code: int, body: Dict[str, Any]):
          """Consistent JSON response wrapper."""
          return {"statusCode": status_code, "body": json.dumps(body)}
      
      
      def placeholder_tool(event: Dict[str, Any]):
          """
          no-op placeholder tool.
      
          Demonstrates argument passing from AgentCore Gateway.
          """
          return {
              "message": "Placeholder tool executed.",
              "string_param": event.get("string_param"),
              "int_param": event.get("int_param"),
              "float_array_param": event.get("float_array_param"),
              "event_args_received": event,
          }
    ''',
    'run_local_server.py': '''
      import uvicorn
      
      """
      Runs the entrypoint as a local uvicorn app with hot-reloading. If the app is configured to hit a remote MCP behind a gateway,
      first deploy the application.
      """
      
      if __name__ == "__main__":
          uvicorn.run(
              "src.main:app",
              host="127.0.0.1",
              port=8000,
              reload=True,
          )
    ''',
    'src': None,
    'src/.dockerignore': '''
      # Build artifacts
      build/
      dist/
      *.egg-info/
      *.egg
      
      # Python cache
      __pycache__/
      __pycache__*
      *.py[cod]
      *$py.class
      *.so
      .Python
      
      # Virtual environments
      .venv/
      .env
      venv/
      env/
      ENV/
      
      # Testing
      .pytest_cache/
      .coverage
      .coverage*
      htmlcov/
      .tox/
      *.cover
      .hypothesis/
      .mypy_cache/
      .ruff_cache/
      
      # Development
      *.log
      *.bak
      *.swp
      *.swo
      *~
      .DS_Store
      
      # IDEs
      .vscode/
      .idea/
      
      # Version control
      .git/
      .gitignore
      .gitattributes
      
      # Documentation
      docs/
      
      # CI/CD
      .github/
      .gitlab-ci.yml
      .travis.yml
      
      # Project specific
      tests/
      
      # Bedrock AgentCore specific - keep config but exclude runtime files
      .bedrock_agentcore.yaml
      .dockerignore
      .bedrock_agentcore/
      
      # Keep wheelhouse for offline installations
      # wheelhouse/
      
      # Monorepo directories
      cdk/
      terraform/
  
    ''',
    'src/Dockerfile': '''
      FROM ghcr.io/astral-sh/uv:python3.10-bookworm-slim
      WORKDIR /app
      
      # All environment variables in one layer
      ENV UV_SYSTEM_PYTHON=1 \
          UV_COMPILE_BYTECODE=1 \
          UV_NO_PROGRESS=1 \
          PYTHONUNBUFFERED=1 \
          DOCKER_CONTAINER=1
      
      
      
      COPY pyproject.toml pyproject.toml
      # Install from requirements file
      RUN uv pip install -r pyproject.toml
      
      
      
      
      RUN uv pip install aws-opentelemetry-distro>=0.10.1
      
      
      # Signal that this is running in Docker for host binding logic
      ENV DOCKER_CONTAINER=1
      
      # Create non-root user
      RUN useradd -m -u 1000 bedrock_agentcore
      USER bedrock_agentcore
      
      EXPOSE 9000
      EXPOSE 8000
      EXPOSE 8080
      
      # Copy entire project (respecting .dockerignore)
      COPY . .
      
      # Use the full module path
      
      CMD ["opentelemetry-instrument", "python", "-m", "main"]
  
    ''',
    'src/main.py': '''
      from agents import Agent, Runner, function_tool
      from bedrock_agentcore.runtime import BedrockAgentCoreApp
      from mcp_client.client import get_streamable_http_mcp_client
      import logging
      import sys
      
      # Set up logging
      logging.basicConfig(
          level=logging.DEBUG,
          format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
          handlers=[
              logging.StreamHandler(sys.stdout)
          ]
      )
      
      logger = logging.getLogger(__name__)
      
      # Define a simple function tool
      @function_tool
      def add_numbers(a: int, b: int) -> int:
          """Return the sum of two numbers"""
          return a+b
      
      # Import AgentCore Gateway as Streamable HTTP MCP Server
      mcp_server = get_streamable_http_mcp_client()
      
      # Define an Agent with tools
      async def main(query):
          try:
              async with mcp_server as server:
                  agent = Agent(
                      name="bootstrap_agent",
                      mcp_servers=[server],
                      tools=[add_numbers]
                  )
                  result = await Runner.run(agent, query)
                  return result
          except Exception as e:
              logger.error(f"Error during agent execution: {e}", exc_info=True)
              raise e
      
      # Integrate with Bedrock AgentCore
      app = BedrockAgentCoreApp()
      
      @app.entrypoint
      async def agent_invocation(payload, context):
          # assume payload input is structured as { "prompt": "<user input>" }
      
          # Process the user prompt
          prompt = payload.get("prompt", "What is Agentic AI?")
      
          # Run the agent
          result = await main(prompt)
      
          # Return result
          return {"result": result.final_output}
      
      
      if __name__== "__main__":
          app.run()
    ''',
    'src/mcp_client': None,
    'src/mcp_client/client.py': '''
      import os
      from agents.mcp import MCPServerStreamableHttp
      import requests
      
      COGNITO_TOKEN_URL = os.getenv("COGNITO_TOKEN_URL")
      COGNITO_CLIENT_ID = os.getenv("COGNITO_CLIENT_ID")
      COGNITO_CLIENT_SECRET = os.getenv("COGNITO_CLIENT_SECRET")
      COGNITO_SCOPE = os.getenv("COGNITO_SCOPE")
      
      def _get_access_token():
          """
          Make a POST request to the Cognito OAuth token URL using client credentials.
          """
          response = requests.post(
              COGNITO_TOKEN_URL,
              auth=(COGNITO_CLIENT_ID, COGNITO_CLIENT_SECRET),
              data={
                  "grant_type": "client_credentials",
                  "scope": COGNITO_SCOPE,
              },
              headers={"Content-Type": "application/x-www-form-urlencoded"},
          )
          return response.json()["access_token"]
      
      
      def get_streamable_http_mcp_client() -> MCPServerStreamableHttp:
          """
          Returns an MCP Client for AgentCore Gateway compatible with OpenAI Agents SDK
          """
          gateway_url = os.getenv("GATEWAY_URL")
          if not gateway_url:
              raise RuntimeError("Missing required environment variable: GATEWAY_URL")
          access_token = _get_access_token()
          return MCPServerStreamableHttp(
              name="AgentCore Gateway MCP",
              params={
                  "url": gateway_url,
                  "headers": {
                      "Authorization": f"Bearer {access_token}"
                  }
              }
          )
    ''',
    'src/pyproject.toml': '''
      [build-system]
      requires = ["setuptools>=68", "wheel"]
      build-backend = "setuptools.build_meta"
      
      [project]
      name = "testProj"
      version = "0.1.0"
      requires-python = ">=3.10"
      
      dependencies = [
          "bedrock-agentcore >= 1.0.3",
          "openai-agents>=0.4.2",
          "requests >= 2.32.5"
      ]
    ''',
  })
# ---
# name: test_cdk_snapshots[scenario_2][scenario_2-None-source provided; no sdk provider]
  dict({
    '.bedrock_agentcore.yaml': '''
      default_agent: custom_agent
      is_agentcore_bootstrap_project: true
      agents:
        custom_agent:
          name: custom_agent
          entrypoint: <PROJECT_ROOT>/src
          deployment_type: container
          aws:
            region: null
          bedrock_agentcore:
            agent_id: null
            agent_arn: null
            agent_session_id: null
  
    ''',
    'cdk': None,
    'cdk/.gitignore': '''
      *.js
      !jest.config.js
      *.d.ts
      node_modules
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/.npmignore': '''
      *.ts
      !*.d.ts
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/README': '''
      # Welcome to your CDK TypeScript project
      
      This is a blank project for CDK development with TypeScript.
      
      The `cdk.json` file tells the CDK Toolkit how to execute your app.
      
      ## Useful commands
      
      * `npm run build`   compile typescript to js
      * `npm run watch`   watch for changes and compile
      * `npm run test`    perform the jest unit tests
      * `npx cdk deploy`  deploy this stack to your default AWS account/region
      * `npx cdk diff`    compare deployed stack with current state
      * `npx cdk synth`   emits the synthesized CloudFormation template
    ''',
    'cdk/bin': None,
    'cdk/bin/cdk.ts': '''
      #!/usr/bin/env node
      import * as cdk from 'aws-cdk-lib';
      import { BaseStackProps } from '../lib/types';
      import {
        DockerImageStack,
        AgentCoreStack
      } from '../lib/stacks';
      
      const app = new cdk.App();
      const deploymentProps: BaseStackProps = {
        appName: "testProj",
        /* If you don't specify 'env', this stack will be environment-agnostic.
         * Account/Region-dependent features and context lookups will not work,
         * but a single synthesized template can be deployed anywhere. */
      
        /* Uncomment the next line to specialize this stack for the AWS Account
         * and Region that are implied by the current CLI configuration. */
        // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },
      
        /* Uncomment the next line if you know exactly what Account and Region you
         * want to deploy the stack to. */
        // env: { account: '123456789012', region: 'us-east-1' },
      
        /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
      }
      const dockerImageStack = new DockerImageStack(app, `testProj-DockerImageStack`, deploymentProps);
      const agentCoreStack = new AgentCoreStack(app, `testProj-AgentCoreStack`, {
        ...deploymentProps,
        imageUri: dockerImageStack.imageUri
      });
      agentCoreStack.addDependency(dockerImageStack);
    ''',
    'cdk/cdk.json': '''
      {
        "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
        "watch": {
          "include": [
            "**"
          ],
          "exclude": [
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            "**/*.js",
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
          ]
        },
        "context": {
          "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
          "@aws-cdk/core:checkSecretUsage": true,
          "@aws-cdk/core:target-partitions": [
            "aws",
            "aws-cn"
          ],
          "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
          "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
          "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
          "@aws-cdk/aws-iam:minimizePolicies": true,
          "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
          "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
          "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
          "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
          "@aws-cdk/core:enablePartitionLiterals": true,
          "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
          "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
          "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
          "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
          "@aws-cdk/aws-route53-patters:useCertificate": true,
          "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
          "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
          "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
          "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
          "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
          "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
          "@aws-cdk/aws-redshift:columnId": true,
          "@aws-cdk/aws-stepfunctions-tasks:enableEmrServicePolicyV2": true,
          "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
          "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
          "@aws-cdk/aws-kms:aliasNameRef": true,
          "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
          "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
          "@aws-cdk/aws-efs:denyAnonymousAccess": true,
          "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
          "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
          "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
          "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
          "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
          "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
          "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForCodeCommitSource": true,
          "@aws-cdk/aws-cloudwatch-actions:changeLambdaPermissionLogicalIdForLambdaAction": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeysDefaultValueToFalse": true,
          "@aws-cdk/aws-codepipeline:defaultPipelineTypeToV2": true,
          "@aws-cdk/aws-kms:reduceCrossAccountRegionPolicyScope": true,
          "@aws-cdk/aws-eks:nodegroupNameAttribute": true,
          "@aws-cdk/aws-ec2:ebsDefaultGp3Volume": true,
          "@aws-cdk/aws-ecs:removeDefaultDeploymentAlarm": true,
          "@aws-cdk/custom-resources:logApiResponseDataPropertyTrueDefault": false,
          "@aws-cdk/aws-s3:keepNotificationInImportedBucket": false,
          "@aws-cdk/aws-ecs:enableImdsBlockingDeprecatedFeature": false,
          "@aws-cdk/aws-ecs:disableEcsImdsBlocking": true,
          "@aws-cdk/aws-ecs:reduceEc2FargateCloudWatchPermissions": true,
          "@aws-cdk/aws-dynamodb:resourcePolicyPerReplica": true,
          "@aws-cdk/aws-ec2:ec2SumTImeoutEnabled": true,
          "@aws-cdk/aws-appsync:appSyncGraphQLAPIScopeLambdaPermission": true,
          "@aws-cdk/aws-rds:setCorrectValueForDatabaseInstanceReadReplicaInstanceResourceId": true,
          "@aws-cdk/core:cfnIncludeRejectComplexResourceUpdateCreatePolicyIntrinsics": true,
          "@aws-cdk/aws-lambda-nodejs:sdkV3ExcludeSmithyPackages": true,
          "@aws-cdk/aws-stepfunctions-tasks:fixRunEcsTaskPolicy": true,
          "@aws-cdk/aws-ec2:bastionHostUseAmazonLinux2023ByDefault": true,
          "@aws-cdk/aws-route53-targets:userPoolDomainNameMethodWithoutCustomResource": true,
          "@aws-cdk/aws-elasticloadbalancingV2:albDualstackWithoutPublicIpv4SecurityGroupRulesDefault": true,
          "@aws-cdk/aws-iam:oidcRejectUnauthorizedConnections": true
        }
      }
    ''',
    'cdk/jest.config.js': '''
      module.exports = {
        testEnvironment: 'node',
        roots: ['<rootDir>/test'],
        testMatch: ['**/*.test.ts'],
        transform: {
          '^.+\\.tsx?$': 'ts-jest'
        }
      };
    ''',
    'cdk/lib': None,
    'cdk/lib/stacks': None,
    'cdk/lib/stacks/agentcore-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as bedrockagentcore from 'aws-cdk-lib/aws-bedrockagentcore';
      import * as iam from 'aws-cdk-lib/aws-iam';
      import * as lambda from 'aws-cdk-lib/aws-lambda'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface AgentCoreStackProps extends BaseStackProps {
          imageUri: string
      }
      
      export class AgentCoreStack extends cdk.Stack {
          readonly agentCoreRuntime: bedrockagentcore.CfnRuntime;
          readonly agentCoreGateway: bedrockagentcore.CfnGateway;
          readonly agentCoreMemory: bedrockagentcore.CfnMemory;
          readonly mcpLambda: lambda.Function;
      
          constructor(scope: Construct, id: string, props: AgentCoreStackProps) {
              super(scope, id, props);
      
              const region = cdk.Stack.of(this).region;
              const accountId = cdk.Stack.of(this).account;
              
              /*****************************
              * AgentCore Memory
              ******************************/
      
              this.agentCoreMemory = new bedrockagentcore.CfnMemory(this, `${props.appName}-AgentCoreMemory`, {
                  name: "bootstrap_agent_memory",
                  eventExpiryDuration: 30,
                  description: "Memory resource with 30 days event expiry",
                  memoryStrategies: [
                      {
                          userPreferenceMemoryStrategy: {
                              name: "UserPreferences",
                              namespaces: ["/users/{actorId}/preferences"],
                              description: "Instance of built-in user preference memory strategy"
                          }
                      },
                      {
                          semanticMemoryStrategy: {
                              name: "SemanticFacts",
                              namespaces: ["/users/{actorId}/facts"],
                              description: "Instance of built-in semantic memory strategy"
                          }
                      },
                      {
                          summaryMemoryStrategy: {
                              name: "SessionSummaries",
                              namespaces: ["/summaries/{actorId}/{sessionId}"],
                              description: "Instance of built-in summary memory strategy"
                          }
                      }
                  ],
              });
              
              /*****************************
              * AgentCore Runtime
              ******************************/
      
              // taken from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-permissions.html#runtime-permissions-execution
              const runtimePolicy = new iam.PolicyDocument({
                  statements: [
                      new iam.PolicyStatement({
                          sid: 'ECRImageAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:BatchGetImage', 'ecr:GetDownloadUrlForLayer'],
                          resources: [
                              `arn:aws:ecr:${region}:${accountId}:repository/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogStreams', 'logs:CreateLogGroup'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogGroups'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'ECRTokenAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:GetAuthorizationToken'],
                          resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'xray:PutTraceSegments',
                              'xray:PutTelemetryRecords',
                              'xray:GetSamplingRules',
                              'xray:GetSamplingTargets',
                          ],
                      resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['cloudwatch:PutMetricData'],
                          resources: ['*'],
                          conditions: {
                              StringEquals: { 'cloudwatch:namespace': 'bedrock-agentcore' },
                          },
                      }),
                      new iam.PolicyStatement({
                          sid: 'GetAgentAccessToken',
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'bedrock-agentcore:GetWorkloadAccessToken',
                              'bedrock-agentcore:GetWorkloadAccessTokenForJWT',
                              'bedrock-agentcore:GetWorkloadAccessTokenForUserId',
                          ],
                          resources: [
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default`,
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default/workload-identity/agentName-*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'BedrockModelInvocation',
                          effect: iam.Effect.ALLOW,
                          actions: ['bedrock:InvokeModel', 'bedrock:InvokeModelWithResponseStream'],
                          resources: [
                              `arn:aws:bedrock:*::foundation-model/*`,
                              `arn:aws:bedrock:${region}:${accountId}:*`,
                          ],
                      }),
                  ],
              });
      
              const runtimeRole = new iam.Role(this, `${props.appName}-AgentCoreRuntimeRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
                  inlinePolicies: {
                      RuntimeAccessPolicy: runtimePolicy
                  }
              });
      
              this.agentCoreRuntime = new bedrockagentcore.CfnRuntime(this, `${props.appName}-AgentCoreRuntime`, {
                  agentRuntimeArtifact: {
                      containerConfiguration: {
                          containerUri: props.imageUri
                      }
                  },
                  agentRuntimeName: "custom_agent",
                  protocolConfiguration: "HTTP",
                  networkConfiguration: {
                      networkMode: "PUBLIC"
                  },
                  roleArn: runtimeRole.roleArn,
                  environmentVariables: {
                      "MEMORY_ID":  this.agentCoreMemory.attrMemoryId,
                  },
                  authorizerConfiguration: {
                      customJwtAuthorizer: {
                          discoveryUrl: "https://aws.dev",
                          allowedClients: ["12345", "6789"],
                          allowedAudience: []
                      }
                  }
              });
      
              // DEFAULT endpoint always points to newest published version. Optionally, can use these versioned endpoints below
              // https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agent-runtime-versioning.html
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeProdEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "PROD"
              });
      
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeDevEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "DEV"
              });
          }
      }
    ''',
    'cdk/lib/stacks/docker-image-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as ecr_assets from 'aws-cdk-lib/aws-ecr-assets'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface DockerImageStackProps extends BaseStackProps {}
      
      export class DockerImageStack extends cdk.Stack {
          readonly imageUri: string
      
          constructor(scope: Construct, id: string, props: DockerImageStackProps) {
              super(scope, id, props);
      
              const asset = new ecr_assets.DockerImageAsset(this, `${props.appName}-AppImage`, {
                  directory: path.join(__dirname, "../../../src/"), // path to root of the project
              });
      
              this.imageUri = asset.imageUri;
              new cdk.CfnOutput(this, 'ImageUri', { value: this.imageUri });
          }
      }
    ''',
    'cdk/lib/stacks/index.ts': '''
      export * from './docker-image-stack';
      export * from './agentcore-stack';
    ''',
    'cdk/lib/test': None,
    'cdk/lib/test/cdk.test.ts': '''
      // import * as cdk from 'aws-cdk-lib';
      // import { Template } from 'aws-cdk-lib/assertions';
      // import * as Cdk from '../lib/cdk-stack';
      
      // example test. To run these tests, uncomment this file along with the
      // example resource in lib/cdk-stack.ts
      test('SQS Queue Created', () => {
      //   const app = new cdk.App();
      //     // WHEN
      //   const stack = new Cdk.CdkStack(app, 'MyTestStack');
      //     // THEN
      //   const template = Template.fromStack(stack);
      
      //   template.hasResourceProperties('AWS::SQS::Queue', {
      //     VisibilityTimeout: 300
      //   });
      });
    ''',
    'cdk/lib/types.ts': '''
      import * as cdk from 'aws-cdk-lib/core'
      
      export interface BaseStackProps extends cdk.StackProps {
          appName: string
      }
    ''',
    'cdk/package.json': '''
      {
        "name": "cdk",
        "version": "0.1.0",
        "bin": {
          "cdk": "bin/cdk.js"
        },
        "engines": {
          "node": ">=18.0.0"
        },
        "scripts": {
          "build": "tsc",
          "watch": "tsc -w",
          "test": "jest",
          "cdk": "cdk",
          "cdk:deploy": "cdk deploy --all",
          "cdk:deploy:ci": "cdk deploy --all --require-approval never"
        },
        "devDependencies": {
          "@types/jest": "^29.5.14",
          "@types/node": "22.7.9",
          "aws-cdk": "^2.1031.1",
          "jest": "^29.7.0",
          "ts-jest": "^29.2.5",
          "ts-node": "^10.9.2",
          "typescript": "~5.6.3"
        },
        "dependencies": {
          "aws-cdk-lib": "^2.221.1",
          "constructs": "^10.4.2"
        }
      }
    ''',
    'cdk/tsconfig.json': '''
      {
        "compilerOptions": {
          "target": "ES2020",
          "module": "commonjs",
          "lib": [
            "es2020",
            "dom"
          ],
          "declaration": true,
          "strict": true,
          "noImplicitAny": true,
          "strictNullChecks": true,
          "noImplicitThis": true,
          "alwaysStrict": true,
          "noUnusedLocals": false,
          "noUnusedParameters": false,
          "noImplicitReturns": true,
          "noFallthroughCasesInSwitch": false,
          "inlineSourceMap": true,
          "inlineSources": true,
          "experimentalDecorators": true,
          "strictPropertyInitialization": false,
          "typeRoots": [
            "./node_modules/@types"
          ]
        },
        "exclude": [
          "node_modules",
          "cdk.out"
        ]
      }
    ''',
    'src': None,
    'src/.dockerignore': 'Dummy Dockerignore!',
    'src/Dockerfile': 'Dummy Dockerfile!',
    'src/requirements.txt': 'strands-agents >= 1.0.0',
    'src/src': None,
    'src/src/agent': None,
    'src/src/agent/main.py': '''
      from strands import Agent
      
      Agent("run!")
    ''',
  })
# ---
# name: test_cdk_snapshots[scenario_3][scenario_3-LangGraph-lang-graph run bootstrap as standalone]
  dict({
    '.bedrock_agentcore.yaml': '''
      default_agent: testProj_Agent
      is_agentcore_bootstrap_project: true
      agents:
        testProj_Agent:
          name: testProj_Agent
          entrypoint: <PROJECT_ROOT>/src
          deployment_type: container
          aws:
            region: null
          bedrock_agentcore:
            agent_id: null
            agent_arn: null
            agent_session_id: null
  
    ''',
    'README.md': '''
      This is a monorepo generated by the agentcore bootstrap CLI tool!
      
      # Deploying
      
      If you want to skip the explanation of the `src/` directory and deploy straight away, see the below cdk/ section.
      
      # Layout
      
      There are three main directories created in this project: `src`, `mcp`, and `cdk`. In a monorepo setup all of the code—source, test, and IaC for deployment—is contained in one repository. Everything needed to
      define runtime code and deploy it into your AWS account is contained in this project.
      
      The `cdk` directory models all of the Bedrock AgentCore and related resources. There are direct references between `cdk` and the runtime `src/`. For example, the IaC code expects to find the
      Dockerfile at a specific relative path.
      
      ## src/
      
      The `src/` directory is where you will find the runtime code.
      
      Start with main entrypoint to the generated app, `src/main.py`. This file defines an agent using LangGraph and defines an entrypoint method with the Bedrock AgentCore SDK:
      
      ```
      @app.entrypoint
      def invoke(payload):
          # assume payload input is structured as { "prompt": "<user input>" }
      ```
      
      Next there is the `src/mcp_client` directory. Here you will find `client.py`. This file defines an MCP client from the chosen LangGraph library. That client points to the
      gateway URL for the AgentCore gateway that is modeled in the `cdk` directory. Behind that gateway is a custom MCP tool modeled as a Lambda function (see below `mcp/` section for more details).
      The authorizer for the gateway is a Cognito app client that is modeled in the `cdk` directory. A call using
      the client_credentials flow is defined in `_get_access_token()`.
      
      ## mcp/
      
      The `mcp/` directory defines a simple Python tool that meets the MCP specification called `placeholder_tool`. The specification for the tool's inputs is defined in the inline schema in the modeled
      `cdk` directory. When replacing the dummy implementation in `mcp/lambda/handler.py`, make sure to update the corresponding Lambda target schema to reflect the changes before re-deploying.
      The `placeholder_tool` implementation demonstrates the tool name and input payload conventions of a Lambda behind the gateway. The gateway supports [flexible target types](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-add-target-api.html).
      
      ## cdk/
      
      This directory contains a CDK project that models AgentCore and related AWS resources.
      
      First check that Node version is >= 18:
      - `node -v` → example output: `v18.19.0`
      - [nvm](https://github.com/nvm-sh/nvm) is a helpful tool to manage Node versions
      
      To deploy your project:
      
      - shorthand: `cd cdk && npm install && npm run cdk synth && npm run cdk:deploy`
      - navigate to the `cdk` directory: `cd cdk`
      - install dependencies: `npm install`
      - synth the CDK project: `npm run cdk synth`
      - deploy all stacks: `npm run cdk:deploy`
      
      # `agentcore bootstrap` output
      
      Primarily, `agentcore bootstrap` outputs the directory that this `README.md` file is contained in. Nothing is deployed into AWS automatically.
      Execute the appropriate deployment commands in the `cdk` directory to deploy.
      
      There is also a `.bedrock_agentcore.yaml` file output in the `testProj` directory. This file contains a minimal definition with your agent name when it is created. After deploying the project, when running
      `agentcore invoke` or `agentcore status`, the command updates `.bedrock_agentcore.yaml` with the ID and ARN of your runtime so the CLI can successfully call the runtime using boto3.
      
      # Invoking the deployed Runtime
      
      The two easiest ways to invoke your runtime after deploying:
      
      1. `agentcore invoke`
         Example:
         ```
         agentcore invoke '{"prompt": "what can you do?"}'
         ```
      
      2. Navigate to the “Test Console” page in the Bedrock AgentCore AWS console. Select your runtime and the `DEFAULT` version. Provide an input.
         Example:
         ```
         {"prompt": "what can you do?"}
         ```
    ''',
    'cdk': None,
    'cdk/.gitignore': '''
      *.js
      !jest.config.js
      *.d.ts
      node_modules
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/.npmignore': '''
      *.ts
      !*.d.ts
      
      # CDK asset staging directory
      .cdk.staging
      cdk.out
    ''',
    'cdk/README': '''
      # Welcome to your CDK TypeScript project
      
      This is a blank project for CDK development with TypeScript.
      
      The `cdk.json` file tells the CDK Toolkit how to execute your app.
      
      ## Useful commands
      
      * `npm run build`   compile typescript to js
      * `npm run watch`   watch for changes and compile
      * `npm run test`    perform the jest unit tests
      * `npx cdk deploy`  deploy this stack to your default AWS account/region
      * `npx cdk diff`    compare deployed stack with current state
      * `npx cdk synth`   emits the synthesized CloudFormation template
    ''',
    'cdk/bin': None,
    'cdk/bin/cdk.ts': '''
      #!/usr/bin/env node
      import * as cdk from 'aws-cdk-lib';
      import { BaseStackProps } from '../lib/types';
      import {
        DockerImageStack,
        AgentCoreStack
      } from '../lib/stacks';
      
      const app = new cdk.App();
      const deploymentProps: BaseStackProps = {
        appName: "testProj",
        /* If you don't specify 'env', this stack will be environment-agnostic.
         * Account/Region-dependent features and context lookups will not work,
         * but a single synthesized template can be deployed anywhere. */
      
        /* Uncomment the next line to specialize this stack for the AWS Account
         * and Region that are implied by the current CLI configuration. */
        // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },
      
        /* Uncomment the next line if you know exactly what Account and Region you
         * want to deploy the stack to. */
        // env: { account: '123456789012', region: 'us-east-1' },
      
        /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
      }
      const dockerImageStack = new DockerImageStack(app, `testProj-DockerImageStack`, deploymentProps);
      const agentCoreStack = new AgentCoreStack(app, `testProj-AgentCoreStack`, {
        ...deploymentProps,
        imageUri: dockerImageStack.imageUri
      });
      agentCoreStack.addDependency(dockerImageStack);
    ''',
    'cdk/cdk.json': '''
      {
        "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
        "watch": {
          "include": [
            "**"
          ],
          "exclude": [
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            "**/*.js",
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
          ]
        },
        "context": {
          "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
          "@aws-cdk/core:checkSecretUsage": true,
          "@aws-cdk/core:target-partitions": [
            "aws",
            "aws-cn"
          ],
          "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
          "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
          "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
          "@aws-cdk/aws-iam:minimizePolicies": true,
          "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
          "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
          "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
          "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
          "@aws-cdk/core:enablePartitionLiterals": true,
          "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
          "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
          "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
          "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
          "@aws-cdk/aws-route53-patters:useCertificate": true,
          "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
          "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
          "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
          "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
          "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
          "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
          "@aws-cdk/aws-redshift:columnId": true,
          "@aws-cdk/aws-stepfunctions-tasks:enableEmrServicePolicyV2": true,
          "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
          "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
          "@aws-cdk/aws-kms:aliasNameRef": true,
          "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
          "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
          "@aws-cdk/aws-efs:denyAnonymousAccess": true,
          "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
          "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
          "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
          "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
          "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
          "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
          "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForCodeCommitSource": true,
          "@aws-cdk/aws-cloudwatch-actions:changeLambdaPermissionLogicalIdForLambdaAction": true,
          "@aws-cdk/aws-codepipeline:crossAccountKeysDefaultValueToFalse": true,
          "@aws-cdk/aws-codepipeline:defaultPipelineTypeToV2": true,
          "@aws-cdk/aws-kms:reduceCrossAccountRegionPolicyScope": true,
          "@aws-cdk/aws-eks:nodegroupNameAttribute": true,
          "@aws-cdk/aws-ec2:ebsDefaultGp3Volume": true,
          "@aws-cdk/aws-ecs:removeDefaultDeploymentAlarm": true,
          "@aws-cdk/custom-resources:logApiResponseDataPropertyTrueDefault": false,
          "@aws-cdk/aws-s3:keepNotificationInImportedBucket": false,
          "@aws-cdk/aws-ecs:enableImdsBlockingDeprecatedFeature": false,
          "@aws-cdk/aws-ecs:disableEcsImdsBlocking": true,
          "@aws-cdk/aws-ecs:reduceEc2FargateCloudWatchPermissions": true,
          "@aws-cdk/aws-dynamodb:resourcePolicyPerReplica": true,
          "@aws-cdk/aws-ec2:ec2SumTImeoutEnabled": true,
          "@aws-cdk/aws-appsync:appSyncGraphQLAPIScopeLambdaPermission": true,
          "@aws-cdk/aws-rds:setCorrectValueForDatabaseInstanceReadReplicaInstanceResourceId": true,
          "@aws-cdk/core:cfnIncludeRejectComplexResourceUpdateCreatePolicyIntrinsics": true,
          "@aws-cdk/aws-lambda-nodejs:sdkV3ExcludeSmithyPackages": true,
          "@aws-cdk/aws-stepfunctions-tasks:fixRunEcsTaskPolicy": true,
          "@aws-cdk/aws-ec2:bastionHostUseAmazonLinux2023ByDefault": true,
          "@aws-cdk/aws-route53-targets:userPoolDomainNameMethodWithoutCustomResource": true,
          "@aws-cdk/aws-elasticloadbalancingV2:albDualstackWithoutPublicIpv4SecurityGroupRulesDefault": true,
          "@aws-cdk/aws-iam:oidcRejectUnauthorizedConnections": true
        }
      }
    ''',
    'cdk/jest.config.js': '''
      module.exports = {
        testEnvironment: 'node',
        roots: ['<rootDir>/test'],
        testMatch: ['**/*.test.ts'],
        transform: {
          '^.+\\.tsx?$': 'ts-jest'
        }
      };
    ''',
    'cdk/lib': None,
    'cdk/lib/stacks': None,
    'cdk/lib/stacks/agentcore-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as bedrockagentcore from 'aws-cdk-lib/aws-bedrockagentcore';
      import * as iam from 'aws-cdk-lib/aws-iam';
      import * as lambda from 'aws-cdk-lib/aws-lambda'
      import * as cognito from 'aws-cdk-lib/aws-cognito';
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface AgentCoreStackProps extends BaseStackProps {
          imageUri: string
      }
      
      export class AgentCoreStack extends cdk.Stack {
          readonly agentCoreRuntime: bedrockagentcore.CfnRuntime;
          readonly agentCoreGateway: bedrockagentcore.CfnGateway;
          readonly agentCoreMemory: bedrockagentcore.CfnMemory;
          readonly mcpLambda: lambda.Function;
      
          constructor(scope: Construct, id: string, props: AgentCoreStackProps) {
              super(scope, id, props);
      
              const region = cdk.Stack.of(this).region;
              const accountId = cdk.Stack.of(this).account;
              /*****************************
              * AgentCore Gateway
              ******************************/
      
              this.mcpLambda = new lambda.Function(this, `${props.appName}-McpLambda`, {
                  runtime: lambda.Runtime.PYTHON_3_12,
                  handler: "handler.lambda_handler",
                  code: lambda.AssetCode.fromAsset(path.join(__dirname, '../../../mcp/lambda'))
              });
      
              const agentCoreGatewayRole = new iam.Role(this, `${props.appName}-AgentCoreGatewayRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
              });
      
              this.mcpLambda.grantInvoke(agentCoreGatewayRole);
      
              // Create gateway resource
              // Cognito resources
              const cognitoUserPool = new cognito.UserPool(this, `${props.appName}-CognitoUserPool`);
      
              // create resource server to work with client credentials auth flow
              const cognitoResourceServerScope = {
                  scopeName: 'basic',
                  scopeDescription: 'Basic access to testProj',
              };
      
              const cognitoResourceServer = cognitoUserPool.addResourceServer(`${props.appName}-CognitoResourceServer`, {
                  identifier: `${props.appName}-CognitoResourceServer`,
                  scopes: [cognitoResourceServerScope],
              });
      
              const cognitoAppClient = new cognito.UserPoolClient(this, `${props.appName}-CognitoAppClient`, {
                  userPool: cognitoUserPool,
                  generateSecret: true,
                  oAuth: {
                      flows: {
                          clientCredentials: true,
                      },
                      scopes: [cognito.OAuthScope.resourceServer(cognitoResourceServer, cognitoResourceServerScope)],
                  },
                  supportedIdentityProviders: [cognito.UserPoolClientIdentityProvider.COGNITO],
              });
              const cognitoDomain = cognitoUserPool.addDomain(`${props.appName}-CognitoDomain`, {
                  cognitoDomain: {
                      domainPrefix: `${props.appName}-${region}`,
                  },
              });
              const cognitoTokenUrl = cognitoDomain.baseUrl() + '/oauth2/token';
      
              this.agentCoreGateway = new bedrockagentcore.CfnGateway(this, `${props.appName}-AgentCoreGateway`, {
                  name: `${props.appName}-AgentCoreGateway`,
                  protocolType: "MCP",
                  roleArn: agentCoreGatewayRole.roleArn,
                  authorizerType: "CUSTOM_JWT",
                  authorizerConfiguration: {
                      customJwtAuthorizer: {
                      discoveryUrl:
                          'https://cognito-idp.' +
                          region +
                          '.amazonaws.com/' +
                          cognitoUserPool.userPoolId +
                          '/.well-known/openid-configuration',
                      allowedClients: [cognitoAppClient.userPoolClientId],
                      },
                  },
              });
      
              new bedrockagentcore.CfnGatewayTarget(this, `${props.appName}-AgentCoreGatewayLambdaTarget`, {
                  name: `${props.appName}-AgentCoreGatewayLambdaTarget`,
                  gatewayIdentifier: this.agentCoreGateway.attrGatewayIdentifier,
                  credentialProviderConfigurations: [
                      {
                          credentialProviderType: "GATEWAY_IAM_ROLE",
                      },
                  ],
                  targetConfiguration: {
                      mcp: {
                          lambda: {
                              lambdaArn: this.mcpLambda.functionArn,
                              toolSchema: {
                                  inlinePayload: [
                                      {
                                          name: "placeholder_tool",
                                          description: "No-op tool that demonstrates passing arguments",
                                          inputSchema: {
                                              type: "object",
                                              properties: {
                                                  string_param: { type: 'string', description: 'Example string parameter' },
                                                  int_param: { type: 'integer', description: 'Example integer parameter' },
                                                  float_array_param: {
                                                      type: 'array',
                                                      description: 'Example float array parameter',
                                                      items: {
                                                          type: 'number',
                                                      }
                                                  }
                                              },
                                              required: []
                                          }
                                      }
                                  ]
                              }
                          }
                      }
                  }
              })
              
              /*****************************
              * AgentCore Memory
              ******************************/
      
              this.agentCoreMemory = new bedrockagentcore.CfnMemory(this, `${props.appName}-AgentCoreMemory`, {
                  name: "testProj_Memory",
                  eventExpiryDuration: 30,
                  description: "Memory resource with 30 days event expiry",
                  memoryStrategies: [
                      // can take a built-in strategy from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/built-in-strategies.html or define a custom one
                  ],
              });
              
              /*****************************
              * AgentCore Runtime
              ******************************/
      
              // taken from https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-permissions.html#runtime-permissions-execution
              const runtimePolicy = new iam.PolicyDocument({
                  statements: [
                      new iam.PolicyStatement({
                          sid: 'ECRImageAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:BatchGetImage', 'ecr:GetDownloadUrlForLayer'],
                          resources: [
                              `arn:aws:ecr:${region}:${accountId}:repository/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogStreams', 'logs:CreateLogGroup'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:DescribeLogGroups'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
                          resources: [
                              `arn:aws:logs:${region}:${accountId}:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'ECRTokenAccess',
                          effect: iam.Effect.ALLOW,
                          actions: ['ecr:GetAuthorizationToken'],
                          resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'xray:PutTraceSegments',
                              'xray:PutTelemetryRecords',
                              'xray:GetSamplingRules',
                              'xray:GetSamplingTargets',
                          ],
                      resources: ['*'],
                      }),
                      new iam.PolicyStatement({
                          effect: iam.Effect.ALLOW,
                          actions: ['cloudwatch:PutMetricData'],
                          resources: ['*'],
                          conditions: {
                              StringEquals: { 'cloudwatch:namespace': 'bedrock-agentcore' },
                          },
                      }),
                      new iam.PolicyStatement({
                          sid: 'GetAgentAccessToken',
                          effect: iam.Effect.ALLOW,
                          actions: [
                              'bedrock-agentcore:GetWorkloadAccessToken',
                              'bedrock-agentcore:GetWorkloadAccessTokenForJWT',
                              'bedrock-agentcore:GetWorkloadAccessTokenForUserId',
                          ],
                          resources: [
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default`,
                              `arn:aws:bedrock-agentcore:${region}:${accountId}:workload-identity-directory/default/workload-identity/agentName-*`,
                          ],
                      }),
                      new iam.PolicyStatement({
                          sid: 'BedrockModelInvocation',
                          effect: iam.Effect.ALLOW,
                          actions: ['bedrock:InvokeModel', 'bedrock:InvokeModelWithResponseStream'],
                          resources: [
                              `arn:aws:bedrock:*::foundation-model/*`,
                              `arn:aws:bedrock:${region}:${accountId}:*`,
                          ],
                      }),
                  ],
              });
      
              const runtimeRole = new iam.Role(this, `${props.appName}-AgentCoreRuntimeRole`, {
                  assumedBy: new iam.ServicePrincipal('bedrock-agentcore.amazonaws.com'),
                  description: 'IAM role for Bedrock AgentCore Runtime',
                  inlinePolicies: {
                      RuntimeAccessPolicy: runtimePolicy
                  }
              });
      
              this.agentCoreRuntime = new bedrockagentcore.CfnRuntime(this, `${props.appName}-AgentCoreRuntime`, {
                  agentRuntimeArtifact: {
                      containerConfiguration: {
                          containerUri: props.imageUri
                      }
                  },
                  agentRuntimeName: "testProj_Agent",
                  protocolConfiguration: "HTTP",
                  networkConfiguration: {
                      networkMode: "PUBLIC"
                  },
                  roleArn: runtimeRole.roleArn,
                  environmentVariables: {
                      "GATEWAY_URL": this.agentCoreGateway.attrGatewayUrl,
                      "MEMORY_ID":  this.agentCoreMemory.attrMemoryId,
                      "COGNITO_CLIENT_ID": cognitoAppClient.userPoolClientId,
                      "COGNITO_CLIENT_SECRET": cognitoAppClient.userPoolClientSecret.unsafeUnwrap(), // alternatives to consider: agentcore identity (no cdk constructs yet) or secrets manager
                      "COGNITO_TOKEN_URL": cognitoTokenUrl,
                      "COGNITO_SCOPE": `${cognitoResourceServer.userPoolResourceServerId}/${cognitoResourceServerScope.scopeName}`
                  }
              });
      
              // DEFAULT endpoint always points to newest published version. Optionally, can use these versioned endpoints below
              // https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agent-runtime-versioning.html
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeProdEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "PROD"
              });
      
              void new bedrockagentcore.CfnRuntimeEndpoint(this, `${props.appName}-AgentCoreRuntimeDevEndpoint`, {
                  agentRuntimeId: this.agentCoreRuntime.attrAgentRuntimeId,
                  agentRuntimeVersion: "1",
                  name: "DEV"
              });
          }
      }
    ''',
    'cdk/lib/stacks/docker-image-stack.ts': '''
      import * as cdk from 'aws-cdk-lib/core';
      import { Construct } from 'constructs/lib/construct';
      import * as ecr_assets from 'aws-cdk-lib/aws-ecr-assets'
      import { BaseStackProps } from '../types';
      import * as path from 'path';
      
      export interface DockerImageStackProps extends BaseStackProps {}
      
      export class DockerImageStack extends cdk.Stack {
          readonly imageUri: string
      
          constructor(scope: Construct, id: string, props: DockerImageStackProps) {
              super(scope, id, props);
      
              const asset = new ecr_assets.DockerImageAsset(this, `${props.appName}-AppImage`, {
                  directory: path.join(__dirname, "../../../src/"), // path to root of the project
              });
      
              this.imageUri = asset.imageUri;
              new cdk.CfnOutput(this, 'ImageUri', { value: this.imageUri });
          }
      }
    ''',
    'cdk/lib/stacks/index.ts': '''
      export * from './docker-image-stack';
      export * from './agentcore-stack';
    ''',
    'cdk/lib/test': None,
    'cdk/lib/test/cdk.test.ts': '''
      // import * as cdk from 'aws-cdk-lib';
      // import { Template } from 'aws-cdk-lib/assertions';
      // import * as Cdk from '../lib/cdk-stack';
      
      // example test. To run these tests, uncomment this file along with the
      // example resource in lib/cdk-stack.ts
      test('SQS Queue Created', () => {
      //   const app = new cdk.App();
      //     // WHEN
      //   const stack = new Cdk.CdkStack(app, 'MyTestStack');
      //     // THEN
      //   const template = Template.fromStack(stack);
      
      //   template.hasResourceProperties('AWS::SQS::Queue', {
      //     VisibilityTimeout: 300
      //   });
      });
    ''',
    'cdk/lib/types.ts': '''
      import * as cdk from 'aws-cdk-lib/core'
      
      export interface BaseStackProps extends cdk.StackProps {
          appName: string
      }
    ''',
    'cdk/package.json': '''
      {
        "name": "cdk",
        "version": "0.1.0",
        "bin": {
          "cdk": "bin/cdk.js"
        },
        "engines": {
          "node": ">=18.0.0"
        },
        "scripts": {
          "build": "tsc",
          "watch": "tsc -w",
          "test": "jest",
          "cdk": "cdk",
          "cdk:deploy": "cdk deploy --all",
          "cdk:deploy:ci": "cdk deploy --all --require-approval never"
        },
        "devDependencies": {
          "@types/jest": "^29.5.14",
          "@types/node": "22.7.9",
          "aws-cdk": "^2.1031.1",
          "jest": "^29.7.0",
          "ts-jest": "^29.2.5",
          "ts-node": "^10.9.2",
          "typescript": "~5.6.3"
        },
        "dependencies": {
          "aws-cdk-lib": "^2.221.1",
          "constructs": "^10.4.2"
        }
      }
    ''',
    'cdk/tsconfig.json': '''
      {
        "compilerOptions": {
          "target": "ES2020",
          "module": "commonjs",
          "lib": [
            "es2020",
            "dom"
          ],
          "declaration": true,
          "strict": true,
          "noImplicitAny": true,
          "strictNullChecks": true,
          "noImplicitThis": true,
          "alwaysStrict": true,
          "noUnusedLocals": false,
          "noUnusedParameters": false,
          "noImplicitReturns": true,
          "noFallthroughCasesInSwitch": false,
          "inlineSourceMap": true,
          "inlineSources": true,
          "experimentalDecorators": true,
          "strictPropertyInitialization": false,
          "typeRoots": [
            "./node_modules/@types"
          ]
        },
        "exclude": [
          "node_modules",
          "cdk.out"
        ]
      }
    ''',
    'invoke_local_server.py': '''
      import subprocess
      import sys
      
      if len(sys.argv) < 2:
          print("usage: python invoke_local_server.py 'your prompt'")
          sys.exit(1)
      
      prompt = sys.argv[1]
      
      subprocess.run([
          "curl",
          "-X", "POST",
          "http://127.0.0.1:8000/invocations",
          "-H", "Content-Type: application/json",
      
          "-d", f'{{"payload": {{"prompt": "{prompt}"}}}}'
      
      ])
    ''',
    'mcp': None,
    'mcp/lambda': None,
    'mcp/lambda/handler.py': '''
      import json
      from typing import Any, Dict
      
      
      def lambda_handler(event, context):
          """
          Generic Lambda handler for Bedrock AgentCore Gateway placeholder tool.
      
          Expected input:
              event: {
                  # optional tool arguments
                  "param_0": val0,
                  "param_1": val1,
                  ...
              }
      
          Context should contain:
              context.client_context.custom["bedrockAgentCoreToolName"]
              → e.g. "LambdaTarget___placeholder_tool"
          """
          try:
              extended_name = context.client_context.custom.get("bedrockAgentCoreToolName")
              tool_name = None
      
              # handle agentcore gateway tool naming convention
              # https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-tool-naming.html
              if extended_name and "___" in extended_name:
                  tool_name = extended_name.split("___", 1)[1]
      
              if not tool_name:
                  return _response(400, {"error": "Missing tool name"})
      
              if tool_name != "placeholder_tool":
                  return _response(400, {"error": f"Unknown tool '{tool_name}'"})
      
              result = placeholder_tool(event)
              return _response(200, {"result": result})
      
          except Exception as e:
              return _response(500, {"system_error": str(e)})
      
      
      def _response(status_code: int, body: Dict[str, Any]):
          """Consistent JSON response wrapper."""
          return {"statusCode": status_code, "body": json.dumps(body)}
      
      
      def placeholder_tool(event: Dict[str, Any]):
          """
          no-op placeholder tool.
      
          Demonstrates argument passing from AgentCore Gateway.
          """
          return {
              "message": "Placeholder tool executed.",
              "string_param": event.get("string_param"),
              "int_param": event.get("int_param"),
              "float_array_param": event.get("float_array_param"),
              "event_args_received": event,
          }
    ''',
    'run_local_server.py': '''
      import uvicorn
      
      """
      Runs the entrypoint as a local uvicorn app with hot-reloading. If the app is configured to hit a remote MCP behind a gateway,
      first deploy the application.
      """
      
      if __name__ == "__main__":
          uvicorn.run(
              "src.main:app",
              host="127.0.0.1",
              port=8000,
              reload=True,
          )
    ''',
    'src': None,
    'src/.dockerignore': '''
      # Build artifacts
      build/
      dist/
      *.egg-info/
      *.egg
      
      # Python cache
      __pycache__/
      __pycache__*
      *.py[cod]
      *$py.class
      *.so
      .Python
      
      # Virtual environments
      .venv/
      .env
      venv/
      env/
      ENV/
      
      # Testing
      .pytest_cache/
      .coverage
      .coverage*
      htmlcov/
      .tox/
      *.cover
      .hypothesis/
      .mypy_cache/
      .ruff_cache/
      
      # Development
      *.log
      *.bak
      *.swp
      *.swo
      *~
      .DS_Store
      
      # IDEs
      .vscode/
      .idea/
      
      # Version control
      .git/
      .gitignore
      .gitattributes
      
      # Documentation
      docs/
      
      # CI/CD
      .github/
      .gitlab-ci.yml
      .travis.yml
      
      # Project specific
      tests/
      
      # Bedrock AgentCore specific - keep config but exclude runtime files
      .bedrock_agentcore.yaml
      .dockerignore
      .bedrock_agentcore/
      
      # Keep wheelhouse for offline installations
      # wheelhouse/
      
      # Monorepo directories
      cdk/
      terraform/
  
    ''',
    'src/Dockerfile': '''
      FROM ghcr.io/astral-sh/uv:python3.10-bookworm-slim
      WORKDIR /app
      
      # All environment variables in one layer
      ENV UV_SYSTEM_PYTHON=1 \
          UV_COMPILE_BYTECODE=1 \
          UV_NO_PROGRESS=1 \
          PYTHONUNBUFFERED=1 \
          DOCKER_CONTAINER=1
      
      
      
      COPY pyproject.toml pyproject.toml
      # Install from requirements file
      RUN uv pip install -r pyproject.toml
      
      
      
      
      RUN uv pip install aws-opentelemetry-distro>=0.10.1
      
      
      # Signal that this is running in Docker for host binding logic
      ENV DOCKER_CONTAINER=1
      
      # Create non-root user
      RUN useradd -m -u 1000 bedrock_agentcore
      USER bedrock_agentcore
      
      EXPOSE 9000
      EXPOSE 8000
      EXPOSE 8080
      
      # Copy entire project (respecting .dockerignore)
      COPY . .
      
      # Use the full module path
      
      CMD ["opentelemetry-instrument", "python", "-m", "main"]
  
    ''',
    'src/main.py': '''
      from langchain_core.messages import HumanMessage
      from langchain.agents import create_agent
      from langchain_aws import ChatBedrock
      from langchain.tools import tool
      from bedrock_agentcore import BedrockAgentCoreApp
      from mcp_client.client import get_streamable_http_mcp_client
      
      MODEL_ID="anthropic.claude-3-5-sonnet-20240620-v1:0"
      
      # Initialize the model client
      llm = ChatBedrock(model_id=MODEL_ID)
      
      # Define a simple function tool
      @tool
      def add_numbers(a: int, b: int) -> int:
          """Return the sum of two numbers"""
          return a+b
      
      # Import AgentCore Gateway as Streamable HTTP MCP Client
      mcp_client = get_streamable_http_mcp_client()
      
      # Integrate with Bedrock AgentCore
      app = BedrockAgentCoreApp()
      
      @app.entrypoint
      async def invoke(payload):
          # assume payload input is structured as { "prompt": "<user input>" }
      
          # Load MCP Tools
          tools = await mcp_client.get_tools()
      
          # Define the agent
          graph = create_agent(llm, tools=[add_numbers] + tools)
      
          # Process the user prompt
          prompt = payload.get("prompt", "What is Agentic AI?")
      
          # Run the agent
          result = await graph.ainvoke({"messages": [HumanMessage(content=prompt)]})
      
          # Return result
          return {
              "result": result["messages"][-1].content
          }
      
      if __name__ == "__main__":
          app.run()
    ''',
    'src/mcp_client': None,
    'src/mcp_client/client.py': '''
      import os
      from langchain_mcp_adapters.client import MultiServerMCPClient
      import requests
      
      COGNITO_TOKEN_URL = os.getenv("COGNITO_TOKEN_URL")
      COGNITO_CLIENT_ID = os.getenv("COGNITO_CLIENT_ID")
      COGNITO_CLIENT_SECRET = os.getenv("COGNITO_CLIENT_SECRET")
      COGNITO_SCOPE = os.getenv("COGNITO_SCOPE")
      
      def _get_access_token():
          """
          Make a POST request to the Cognito OAuth token URL using client credentials.
          """
          response = requests.post(
              COGNITO_TOKEN_URL,
              auth=(COGNITO_CLIENT_ID, COGNITO_CLIENT_SECRET),
              data={
                  "grant_type": "client_credentials",
                  "scope": COGNITO_SCOPE,
              },
              headers={"Content-Type": "application/x-www-form-urlencoded"},
          )
          return response.json()["access_token"]
      
      
      def get_streamable_http_mcp_client() -> MultiServerMCPClient:
          """
          Returns an MCP Client for AgentCore Gateway compatible with LangGraph
          """
          gateway_url = os.getenv("GATEWAY_URL")
          if not gateway_url:
              raise RuntimeError("Missing required environment variable: GATEWAY_URL")
          access_token = _get_access_token()
          return MultiServerMCPClient(
              {
                  "agentcore_gateway": {
                      "transport": "streamable_http",
                      "url": gateway_url,
                      "headers": {
                          "Authorization": f"Bearer {access_token}"
                      }
                  }
              }
          )
    ''',
    'src/pyproject.toml': '''
      [build-system]
      requires = ["setuptools>=68", "wheel"]
      build-backend = "setuptools.build_meta"
      
      [project]
      name = "testProj"
      version = "0.1.0"
      requires-python = ">=3.10"
      
      dependencies = [
          "bedrock-agentcore >= 1.0.3",
          "langchain >= 1.0.3",
          "langchain-mcp-adapters >= 0.1.11",
          "langchain_aws >= 1.0.0",
          "langgraph >= 1.0.2",
          "mcp >= 1.19.0",
          "requests >= 2.32.5"
      ]
    ''',
  })
# ---
